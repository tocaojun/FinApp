/**\n * 财富产品收益追踪服务\n * 处理分红型和净值型产品的预期收益与实际收益的偏差计算\n */\n\nimport { databaseService } from './DatabaseService';\n\n// ============================================\n// 类型定义\n// ============================================\n\nexport interface DividendRecord {\n  id?: string;\n  date: Date;\n  rate: number; // 分红率(%%)\n  amount: number; // 分红金额\n  cumulativeDividends?: number;\n}\n\nexport interface DividendReturn {\n  totalDividends: number;\n  expectedReturn: number;\n  actualReturn: number;\n  deviation: number;\n  deviationRatio: number; // 百分比\n  dividendsList: DividendRecord[];\n  status: 'NORMAL' | 'WARNING' | 'ALERT';\n}\n\nexport interface NAVHistory {\n  id?: string;\n  date: Date;\n  nav: number;\n  dailyReturn: number; // 日涨幅(%%)\n  cumulativeReturn: number; // 累计收益率(%%)\n}\n\nexport interface NAVReturn {\n  purchaseNav: number;\n  currentNav: number;\n  shareCount: number;\n  marketValue: number;\n  gainAmount: number;\n  gainRate: number;\n  expectedReturn: number;\n  deviation: number;\n  deviationRatio: number; // 百分比\n  navHistory: NAVHistory[];\n  status: 'NORMAL' | 'WARNING' | 'ALERT';\n}\n\nexport interface WealthTransaction {\n  id?: string;\n  assetId: string;\n  type: 'PURCHASE' | 'REDEMPTION' | 'DIVIDEND' | 'FEE' | 'ADJUSTMENT';\n  date: Date;\n  settlementDate?: Date;\n  amount: number;\n  quantity?: number; // 份额数\n  navPerShare?: number;\n  dividendRate?: number;\n  feeAmount?: number;\n  feeDescription?: string;\n  notes?: string;\n}\n\nexport interface DeviationAnalysis {\n  level: 'NORMAL' | 'WARNING' | 'ALERT';\n  threshold: number;\n  reasons: string[];\n  recommendation: string;\n  trend: number[]; // 最近N天的偏差率走势\n}\n\n// ============================================\n// 常量定义\n// ============================================\n\nconst DEVIATION_THRESHOLDS = {\n  NORMAL: 2,\n  WARNING: 5,\n  ALERT: 10,\n};\n\nconst DEVIATION_REASONS = {\n  MARKET_VOLATILITY: '市场波动',\n  MANAGEMENT_PERFORMANCE: '基金经理操作',\n  FEES_HIGHER: '费用高于预期',\n  LIQUIDITY_RISK: '流动性风险',\n  POLICY_CHANGE: '政策变化',\n  TIMING_MISMATCH: '时间错配',\n  DIVIDEND_DELAY: '分红延迟',\n  EARLY_REDEMPTION: '提前赎回',\n};\n\n// ============================================\n// 财富产品收益服务\n// ============================================\n\nexport class WealthProductReturnService {\n  /**\n   * 计算分红型产品收益\n   */\n  async calculateDividendReturn(\n    assetId: string,\n    investment: number,\n    expectedReturn: number,\n    startDate: Date\n  ): Promise<DividendReturn> {\n    try {\n      // 获取分红记录\n      const dividends = await this.getDividendRecords(assetId);\n      \n      // 计算已收总分红\n      const totalDividends = dividends.reduce((sum, d) => sum + d.amount, 0);\n      \n      // 计算预期收益\n      const expectedAmount = investment * (expectedReturn / 100);\n      \n      // 计算实际收益\n      const actualReturn = totalDividends;\n      \n      // 计算偏差\n      const deviation = actualReturn - expectedAmount;\n      const deviationRatio = expectedAmount !== 0 ? (deviation / expectedAmount) * 100 : 0;\n      \n      // 确定状态\n      const status = this.getDeviationStatus(Math.abs(deviationRatio));\n      \n      return {\n        totalDividends,\n        expectedReturn: expectedAmount,\n        actualReturn,\n        deviation,\n        deviationRatio,\n        dividendsList: dividends,\n        status,\n      };\n    } catch (error) {\n      console.error('Error calculating dividend return:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * 计算净值型产品收益\n   */\n  async calculateNAVReturn(\n    assetId: string,\n    investment: number,\n    purchaseNav: number,\n    expectedAnnualReturn: number,\n    holdingDays: number\n  ): Promise<NAVReturn> {\n    try {\n      // 获取当前净值\n      const currentNav = await this.getCurrentNAV(assetId);\n      const navHistory = await this.getNAVHistory(assetId);\n      \n      // 计算份额数\n      const shareCount = investment / purchaseNav;\n      \n      // 计算当前市值\n      const marketValue = shareCount * currentNav;\n      \n      // 计算实际收益\n      const gainAmount = marketValue - investment;\n      const gainRate = (gainAmount / investment) * 100;\n      \n      // 计算预期收益（按比例时间计算）\n      const expectedReturnRate = (expectedAnnualReturn / 365) * holdingDays;\n      const expectedAmount = investment * (expectedReturnRate / 100);\n      \n      // 计算偏差\n      const deviation = gainAmount - expectedAmount;\n      const deviationRatio = expectedAmount !== 0 ? (deviation / expectedAmount) * 100 : 0;\n      \n      // 确定状态\n      const status = this.getDeviationStatus(Math.abs(deviationRatio));\n      \n      return {\n        purchaseNav,\n        currentNav,\n        shareCount,\n        marketValue,\n        gainAmount,\n        gainRate,\n        expectedReturn: expectedReturnRate,\n        deviation,\n        deviationRatio,\n        navHistory,\n        status,\n      };\n    } catch (error) {\n      console.error('Error calculating NAV return:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * 计算年化收益率\n   */\n  calculateAnnualizedReturn(gainRate: number, holdingDays: number): number {\n    if (holdingDays === 0) return 0;\n    const years = holdingDays / 365.25;\n    const annualizedReturn = ((1 + gainRate / 100) ** (1 / years) - 1) * 100;\n    return annualizedReturn;\n  }\n\n  /**\n   * 计算年化偏差\n   */\n  calculateAnnualizedDeviation(\n    startDate: Date,\n    endDate: Date,\n    deviationRatio: number\n  ): number {\n    const days = (endDate.getTime() - startDate.getTime()) / (1000 * 60 * 60 * 24);\n    const years = days / 365.25;\n    if (years === 0) return 0;\n    return deviationRatio / years;\n  }\n\n  /**\n   * 记录交易/分红\n   */\n  async recordTransaction(transaction: WealthTransaction): Promise<void> {\n    try {\n      const query = `\n        INSERT INTO finapp.wealth_product_transactions (\n          asset_id, transaction_type, transaction_date, settlement_date,\n          amount, quantity, nav_per_share, dividend_rate,\n          fee_amount, fee_description, status, notes\n        ) VALUES (\n          $1::uuid, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12\n        )\n      `;\n      \n      const params = [\n        transaction.assetId,\n        transaction.type,\n        transaction.date,\n        transaction.settlementDate || null,\n        transaction.amount,\n        transaction.quantity || null,\n        transaction.navPerShare || null,\n        transaction.dividendRate || null,\n        transaction.feeAmount || null,\n        transaction.feeDescription || null,\n        'COMPLETED',\n        transaction.notes || null,\n      ];\n      \n      await databaseService.executeRawQuery(query, params);\n    } catch (error) {\n      console.error('Error recording transaction:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * 记录净值历史\n   */\n  async recordNAVHistory(\n    assetId: string,\n    date: Date,\n    nav: number,\n    dailyReturn: number,\n    cumulativeReturn: number\n  ): Promise<void> {\n    try {\n      const query = `\n        INSERT INTO finapp.wealth_product_nav_history (\n          asset_id, nav_date, nav_per_share, daily_return,\n          holding_period_return\n        ) VALUES (\n          $1::uuid, $2, $3, $4, $5\n        )\n        ON CONFLICT (asset_id, nav_date) DO UPDATE SET\n          nav_per_share = $3,\n          daily_return = $4,\n          holding_period_return = $5\n      `;\n      \n      const params = [assetId, date, nav, dailyReturn, cumulativeReturn];\n      \n      await databaseService.executeRawQuery(query, params);\n    } catch (error) {\n      console.error('Error recording NAV history:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * 分析偏差原因\n   */\n  async analyzeDeviations(assetId: string): Promise<DeviationAnalysis> {\n    try {\n      const query = `\n        SELECT\n          wpd.product_subtype,\n          wpd.expected_return,\n          wpd.dividend_frequency,\n          wpd.total_dividends_received,\n          COUNT(wpt.id) as transaction_count,\n          MAX(wpt.transaction_date) as last_transaction_date\n        FROM finapp.wealth_product_details wpd\n        LEFT JOIN finapp.wealth_product_transactions wpt\n          ON wpd.asset_id = wpt.asset_id\n        WHERE wpd.asset_id = $1::uuid\n        GROUP BY wpd.product_subtype, wpd.expected_return, wpd.dividend_frequency, wpd.total_dividends_received\n      `;\n      \n      const result = await databaseService.executeRawQuery(query, [assetId]);\n      \n      if (!result || result.length === 0) {\n        return {\n          level: 'NORMAL',\n          threshold: DEVIATION_THRESHOLDS.NORMAL,\n          reasons: [],\n          recommendation: '暂无偏差数据',\n          trend: [],\n        };\n      }\n      \n      const data = result[0];\n      const reasons: string[] = [];\n      \n      // 分析偏差原因\n      if (data.last_transaction_date) {\n        const daysSinceLast =\n          (Date.now() - new Date(data.last_transaction_date).getTime()) /\n          (1000 * 60 * 60 * 24);\n        \n        if (daysSinceLast > 30 && data.product_subtype === 'DIVIDEND') {\n          reasons.push(DEVIATION_REASONS.DIVIDEND_DELAY);\n        }\n      }\n      \n      // 获取偏差趋势\n      const trend = await this.getDeviationTrend(assetId, 30);\n      const avgDeviation = trend.length > 0\n        ? trend.reduce((a, b) => a + b, 0) / trend.length\n        : 0;\n      \n      const level = this.getDeviationStatus(Math.abs(avgDeviation));\n      \n      return {\n        level,\n        threshold: this.getThreshold(level),\n        reasons,\n        recommendation: this.getRecommendation(level),\n        trend,\n      };\n    } catch (error) {\n      console.error('Error analyzing deviations:', error);\n      throw error;\n    }\n  }\n\n  /**\n   * 获取偏差趋势（最近N天）\n   */\n  async getDeviationTrend(assetId: string, days: number): Promise<number[]> {\n    try {\n      const query = `\n        SELECT\n          nav_date,\n          ((nav_per_share - LAG(nav_per_share) OVER (ORDER BY nav_date)) / \n           LAG(nav_per_share) OVER (ORDER BY nav_date)) * 100 as daily_deviation\n        FROM finapp.wealth_product_nav_history\n        WHERE asset_id = $1::uuid\n          AND nav_date >= CURRENT_DATE - INTERVAL '1 day' * $2\n        ORDER BY nav_date\n      `;\n      \n      const result = await databaseService.executeRawQuery(query, [\n        assetId,\n        days,\n      ]);\n      \n      return result\n        .filter((r: any) => r.daily_deviation !== null)\n        .map((r: any) => parseFloat(r.daily_deviation));\n    } catch (error) {\n      console.error('Error getting deviation trend:', error);\n      return [];\n    }\n  }\n\n  /**\n   * 获取分红记录\n   */\n  private async getDividendRecords(assetId: string): Promise<DividendRecord[]> {\n    const query = `\n      SELECT\n        id,\n        transaction_date as date,\n        dividend_rate as rate,\n        amount,\n        SUM(amount) OVER (ORDER BY transaction_date) as cumulative_dividends\n      FROM finapp.wealth_product_transactions\n      WHERE asset_id = $1::uuid\n        AND transaction_type = 'DIVIDEND'\n      ORDER BY transaction_date\n    `;\n    \n    const result = await databaseService.executeRawQuery(query, [assetId]);\n    \n    return result.map((r: any) => ({\n      id: r.id,\n      date: r.date,\n      rate: parseFloat(r.rate || 0),\n      amount: parseFloat(r.amount),\n      cumulativeDividends: parseFloat(r.cumulative_dividends),\n    }));\n  }\n\n  /**\n   * 获取当前净值\n   */\n  private async getCurrentNAV(assetId: string): Promise<number> {\n    const query = `\n      SELECT nav_per_share\n      FROM finapp.wealth_product_nav_history\n      WHERE asset_id = $1::uuid\n      ORDER BY nav_date DESC\n      LIMIT 1\n    `;\n    \n    const result = await databaseService.executeRawQuery(query, [assetId]);\n    return result.length > 0 ? parseFloat(result[0].nav_per_share) : 1.0;\n  }\n\n  /**\n   * 获取净值历史\n   */\n  private async getNAVHistory(assetId: string): Promise<NAVHistory[]> {\n    const query = `\n      SELECT\n        id,\n        nav_date as date,\n        nav_per_share as nav,\n        daily_return,\n        holding_period_return as cumulative_return\n      FROM finapp.wealth_product_nav_history\n      WHERE asset_id = $1::uuid\n      ORDER BY nav_date DESC\n      LIMIT 100\n    `;\n    \n    const result = await databaseService.executeRawQuery(query, [assetId]);\n    \n    return result.map((r: any) => ({\n      id: r.id,\n      date: r.date,\n      nav: parseFloat(r.nav),\n      dailyReturn: parseFloat(r.daily_return || 0),\n      cumulativeReturn: parseFloat(r.cumulative_return || 0),\n    }));\n  }\n\n  /**\n   * 确定偏差状态\n   */\n  private getDeviationStatus(\n    deviationRatio: number\n  ): 'NORMAL' | 'WARNING' | 'ALERT' {\n    if (deviationRatio <= DEVIATION_THRESHOLDS.NORMAL) {\n      return 'NORMAL';\n    }\n    if (deviationRatio <= DEVIATION_THRESHOLDS.WARNING) {\n      return 'WARNING';\n    }\n    return 'ALERT';\n  }\n\n  /**\n   * 获取阈值\n   */\n  private getThreshold(level: 'NORMAL' | 'WARNING' | 'ALERT'): number {\n    switch (level) {\n      case 'NORMAL':\n        return DEVIATION_THRESHOLDS.NORMAL;\n      case 'WARNING':\n        return DEVIATION_THRESHOLDS.WARNING;\n      case 'ALERT':\n        return DEVIATION_THRESHOLDS.ALERT;\n    }\n  }\n\n  /**\n   * 获取建议\n   */\n  private getRecommendation(level: 'NORMAL' | 'WARNING' | 'ALERT'): string {\n    switch (level) {\n      case 'NORMAL':\n        return '产品运作正常，收益符合预期';\n      case 'WARNING':\n        return '收益偏差较大，建议核查产品表现和费用';\n      case 'ALERT':\n        return '收益偏差严重，建议咨询产品经理或考虑赎回';\n    }\n  }\n}\n\nexport const wealthProductReturnService = new WealthProductReturnService();\n