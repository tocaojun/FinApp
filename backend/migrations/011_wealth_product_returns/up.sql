-- 财富产品收益追踪迁移脚本\n-- 添加分红型和净值型产品的预期收益与实际收益追踪功能\n\n-- ============================================\n-- 1. 扩展 wealth_product_details 表\n-- ============================================\n\nALTER TABLE finapp.wealth_product_details \nADD COLUMN IF NOT EXISTS product_subtype VARCHAR(20) \n  CHECK (product_subtype IN ('DIVIDEND', 'NAV')),\nADD COLUMN IF NOT EXISTS nav_currency VARCHAR(10) DEFAULT 'CNY',\nADD COLUMN IF NOT EXISTS settlement_method VARCHAR(20) DEFAULT 'CASH',\nADD COLUMN IF NOT EXISTS dividend_frequency VARCHAR(20),\nADD COLUMN IF NOT EXISTS total_dividends_received NUMERIC(18,2) DEFAULT 0,\nADD COLUMN IF NOT EXISTS dividend_reinvestment BOOLEAN DEFAULT FALSE,\nADD COLUMN IF NOT EXISTS expected_annual_return NUMERIC(5,2),\nADD COLUMN IF NOT EXISTS ytd_return NUMERIC(5,2),\nADD COLUMN IF NOT EXISTS cumulative_return NUMERIC(5,2),\nADD COLUMN IF NOT EXISTS return_calculation_method VARCHAR(255);\n\n-- ============================================\n-- 2. 创建交易记录表\n-- ============================================\n\nCREATE TABLE IF NOT EXISTS finapp.wealth_product_transactions (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  asset_id UUID NOT NULL REFERENCES finapp.assets(id) ON DELETE CASCADE,\n  \n  -- 交易基本信息\n  transaction_type VARCHAR(20) NOT NULL \n    CHECK (transaction_type IN ('PURCHASE', 'REDEMPTION', 'DIVIDEND', 'FEE', 'ADJUSTMENT')),\n  transaction_date DATE NOT NULL,\n  settlement_date DATE,\n  \n  -- 金额相关\n  amount NUMERIC(18,2) NOT NULL,\n  quantity NUMERIC(18,4),\n  nav_per_share NUMERIC(12,6),\n  \n  -- 分红相关\n  dividend_rate NUMERIC(5,2),\n  cum_dividend_right BOOLEAN DEFAULT FALSE,\n  \n  -- 费用相关\n  fee_amount NUMERIC(10,2),\n  fee_description VARCHAR(255),\n  \n  -- 状态\n  status VARCHAR(20) DEFAULT 'COMPLETED' \n    CHECK (status IN ('PENDING', 'COMPLETED', 'CANCELLED')),\n  notes TEXT,\n  \n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nCREATE INDEX IF NOT EXISTS idx_wealth_transactions_asset \n  ON finapp.wealth_product_transactions(asset_id);\nCREATE INDEX IF NOT EXISTS idx_wealth_transactions_date \n  ON finapp.wealth_product_transactions(transaction_date);\nCREATE INDEX IF NOT EXISTS idx_wealth_transactions_type \n  ON finapp.wealth_product_transactions(transaction_type);\n\n-- ============================================\n-- 3. 创建净值历史表\n-- ============================================\n\nCREATE TABLE IF NOT EXISTS finapp.wealth_product_nav_history (\n  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n  asset_id UUID NOT NULL REFERENCES finapp.assets(id) ON DELETE CASCADE,\n  \n  -- 净值数据\n  nav_date DATE NOT NULL,\n  nav_per_share NUMERIC(12,6) NOT NULL,\n  accumulated_nav NUMERIC(12,6),\n  daily_return NUMERIC(5,4),\n  \n  -- 产品参数\n  holding_period_return NUMERIC(5,2),\n  annualized_return NUMERIC(5,2),\n  volatility NUMERIC(5,2),\n  \n  -- 规模信息\n  fund_size NUMERIC(18,2),\n  share_count NUMERIC(18,4),\n  \n  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);\n\nCREATE INDEX IF NOT EXISTS idx_nav_history_asset \n  ON finapp.wealth_product_nav_history(asset_id);\nCREATE INDEX IF NOT EXISTS idx_nav_history_date \n  ON finapp.wealth_product_nav_history(nav_date);\nCREATE UNIQUE INDEX IF NOT EXISTS idx_nav_history_unique \n  ON finapp.wealth_product_nav_history(asset_id, nav_date);\n\n-- ============================================\n-- 4. 创建收益偏差分析视图\n-- ============================================\n\nCREATE OR REPLACE VIEW finapp.vw_wealth_product_returns AS\nSELECT\n  wpd.id,\n  wpd.asset_id,\n  a.name as product_name,\n  wpd.product_subtype,\n  wpd.issuer,\n  wpd.product_code,\n  wpd.expected_annual_return,\n  wpd.ytd_return,\n  wpd.cumulative_return,\n  wpd.total_dividends_received,\n  COUNT(DISTINCT CASE WHEN wpt.transaction_type = 'DIVIDEND' THEN wpt.id END) as dividend_count,\n  MAX(CASE WHEN wpt.transaction_type = 'DIVIDEND' THEN wpt.transaction_date END) as last_dividend_date,\n  COALESCE(MAX(wph.nav_per_share), 1.0) as current_nav,\n  MAX(wph.nav_date) as nav_update_date,\n  CASE \n    WHEN ABS(COALESCE(wpd.ytd_return, 0) - COALESCE(wpd.expected_annual_return, 0)) <= 2 THEN 'NORMAL'\n    WHEN ABS(COALESCE(wpd.ytd_return, 0) - COALESCE(wpd.expected_annual_return, 0)) <= 5 THEN 'WARNING'\n    ELSE 'ALERT'\n  END as status\nFROM finapp.wealth_product_details wpd\nJOIN finapp.assets a ON wpd.asset_id = a.id\nLEFT JOIN finapp.wealth_product_transactions wpt ON wpd.asset_id = wpt.asset_id\nLEFT JOIN finapp.wealth_product_nav_history wph ON wpd.asset_id = wph.asset_id\nGROUP BY wpd.id, wpd.asset_id, a.name, wpd.product_subtype, wpd.issuer, wpd.product_code, wpd.expected_annual_return, wpd.ytd_return, wpd.cumulative_return, wpd.total_dividends_received;\n\n-- ============================================\n-- 5. 创建偏差分析视图\n-- ============================================\n\nCREATE OR REPLACE VIEW finapp.vw_deviation_analysis AS\nSELECT\n  wpd.asset_id,\n  a.name as product_name,\n  wpd.product_subtype,\n  wpd.expected_annual_return,\n  COALESCE(wpd.ytd_return, 0) as ytd_return,\n  COALESCE(wpd.ytd_return, 0) - COALESCE(wpd.expected_annual_return, 0) as deviation,\n  CASE \n    WHEN COALESCE(wpd.expected_annual_return, 0) = 0 THEN 0\n    ELSE ((COALESCE(wpd.ytd_return, 0) - COALESCE(wpd.expected_annual_return, 0)) / COALESCE(wpd.expected_annual_return, 0)) * 100\n  END as deviation_ratio,\n  CASE \n    WHEN ABS(COALESCE(wpd.ytd_return, 0) - COALESCE(wpd.expected_annual_return, 0)) <= 2 THEN 'NORMAL'\n    WHEN ABS(COALESCE(wpd.ytd_return, 0) - COALESCE(wpd.expected_annual_return, 0)) <= 5 THEN 'WARNING'\n    ELSE 'ALERT'\n  END as risk_level,\n  MAX(CASE WHEN wpt.transaction_type = 'DIVIDEND' THEN wpt.transaction_date END) as last_dividend_date,\n  DATEDIFF(day, MAX(CASE WHEN wpt.transaction_type = 'DIVIDEND' THEN wpt.transaction_date END), CURRENT_DATE) as days_since_dividend,\n  wpd.dividend_frequency\nFROM finapp.wealth_product_details wpd\nJOIN finapp.assets a ON wpd.asset_id = a.id\nLEFT JOIN finapp.wealth_product_transactions wpt ON wpd.asset_id = wpt.asset_id\nGROUP BY wpd.asset_id, a.name, wpd.product_subtype, wpd.expected_annual_return, wpd.ytd_return, wpd.dividend_frequency;\n\n-- ============================================\n-- 6. 创建触发器：自动更新 updated_at\n-- ============================================\n\nCREATE OR REPLACE FUNCTION finapp.update_wealth_transactions_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n  NEW.updated_at = CURRENT_TIMESTAMP;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nDROP TRIGGER IF EXISTS wealth_transactions_update_timestamp ON finapp.wealth_product_transactions;\nCREATE TRIGGER wealth_transactions_update_timestamp\n  BEFORE UPDATE ON finapp.wealth_product_transactions\n  FOR EACH ROW\n  EXECUTE FUNCTION finapp.update_wealth_transactions_updated_at();\n\n-- ============================================\n-- 7. 权限设置\n-- ============================================\n\nALTER TABLE finapp.wealth_product_transactions OWNER TO finapp_user;\nALTER TABLE finapp.wealth_product_nav_history OWNER TO finapp_user;\nALTER VIEW finapp.vw_wealth_product_returns OWNER TO finapp_user;\nALTER VIEW finapp.vw_deviation_analysis OWNER TO finapp_user;\n\n-- ============================================\n-- 完成迁移\n-- ============================================\n\nDO $$\nBEGIN\n  RAISE NOTICE 'Wealth product return tracking migration completed successfully';\nEND $$;\n