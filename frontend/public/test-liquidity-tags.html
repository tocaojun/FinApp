<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµåŠ¨æ€§æ ‡ç­¾æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #1890ff 0%, #096dd9 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        .header p {
            opacity: 0.9;
            font-size: 14px;
        }
        .content {
            padding: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #1890ff;
        }
        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 18px;
        }
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }
        button {
            background: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            font-weight: 500;
        }
        button:hover {
            background: #40a9ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(24, 144, 255, 0.4);
        }
        button:active {
            transform: translateY(0);
        }
        button.secondary {
            background: #52c41a;
        }
        button.secondary:hover {
            background: #73d13d;
        }
        button.danger {
            background: #ff4d4f;
        }
        button.danger:hover {
            background: #ff7875;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e8e8e8;
            min-height: 50px;
        }
        .success {
            color: #52c41a;
            font-weight: 600;
        }
        .error {
            color: #ff4d4f;
            font-weight: 600;
        }
        .info {
            color: #1890ff;
            font-weight: 600;
        }
        .tag {
            display: inline-block;
            padding: 6px 14px;
            margin: 6px;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
        pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.6;
            border: 1px solid #e8e8e8;
        }
        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        .status-badge.online {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
        }
        .status-badge.offline {
            background: #fff1f0;
            color: #ff4d4f;
            border: 1px solid #ffccc7;
        }
        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #1890ff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e8e8e8;
            text-align: center;
        }
        .stat-card .number {
            font-size: 32px;
            font-weight: bold;
            color: #1890ff;
            margin-bottom: 5px;
        }
        .stat-card .label {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” æµåŠ¨æ€§æ ‡ç­¾æµ‹è¯•å·¥å…·</h1>
            <p>FinApp å‰ç«¯è°ƒè¯•åŠ©æ‰‹ - ä½¿ç”¨ç›¸å¯¹è·¯å¾„é¿å…CORSé—®é¢˜</p>
        </div>

        <div class="content">
            <!-- æœåŠ¡çŠ¶æ€ -->
            <div class="test-section">
                <h3>ğŸ“¡ æœåŠ¡çŠ¶æ€æ£€æŸ¥</h3>
                <div class="button-group">
                    <button onclick="checkServices()">æ£€æŸ¥æ‰€æœ‰æœåŠ¡</button>
                </div>
                <div id="serviceStatus" class="result"></div>
            </div>

            <!-- ç™»å½•æµ‹è¯• -->
            <div class="test-section">
                <h3>ğŸ” ç™»å½•æµ‹è¯•</h3>
                <div class="button-group">
                    <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
                    <button class="secondary" onclick="checkToken()">æ£€æŸ¥Token</button>
                </div>
                <div id="loginResult" class="result"></div>
            </div>

            <!-- æµåŠ¨æ€§æ ‡ç­¾æµ‹è¯• -->
            <div class="test-section">
                <h3>ğŸ·ï¸ æµåŠ¨æ€§æ ‡ç­¾æµ‹è¯•</h3>
                <div class="button-group">
                    <button onclick="testGetTags()">è·å–æ‰€æœ‰æ ‡ç­¾</button>
                    <button onclick="testGetActiveTags()">è·å–æ´»è·ƒæ ‡ç­¾</button>
                    <button class="secondary" onclick="showTagsVisual()">å¯è§†åŒ–æ˜¾ç¤º</button>
                </div>
                <div id="tagsResult" class="result"></div>
                <div id="tagsDisplay"></div>
            </div>

            <!-- ç»Ÿè®¡ä¿¡æ¯ -->
            <div class="test-section">
                <h3>ğŸ“Š ç»Ÿè®¡ä¿¡æ¯</h3>
                <div id="statsDisplay" class="stats"></div>
            </div>

            <!-- è°ƒè¯•å·¥å…· -->
            <div class="test-section">
                <h3>ğŸ› ï¸ è°ƒè¯•å·¥å…·</h3>
                <div class="button-group">
                    <button onclick="viewLocalStorage()">æŸ¥çœ‹LocalStorage</button>
                    <button class="danger" onclick="clearAll()">æ¸…é™¤æ‰€æœ‰æ•°æ®</button>
                    <button onclick="copyLogs()">å¤åˆ¶æ—¥å¿—</button>
                </div>
                <div id="debugInfo" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        // ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œé€šè¿‡Viteä»£ç†è®¿é—®API
        const API_BASE_URL = '/api';
        let authToken = '';
        let allLogs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            allLogs.push(logEntry);
            console.log(logEntry);
        }

        // æ£€æŸ¥æœåŠ¡çŠ¶æ€
        async function checkServices() {
            const resultDiv = document.getElementById('serviceStatus');
            resultDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨æ£€æŸ¥æœåŠ¡çŠ¶æ€...';
            
            try {
                // å°è¯•å¤šä¸ªå¥åº·æ£€æŸ¥ç«¯ç‚¹
                let healthData = null;
                let endpoint = '';
                
                // å°è¯• /api/health
                try {
                    const response1 = await fetch('/api/health');
                    if (response1.ok) {
                        healthData = await response1.json();
                        endpoint = '/api/health';
                    }
                } catch (e) {
                    console.log('å°è¯• /api/health å¤±è´¥:', e);
                }
                
                // å¦‚æœå¤±è´¥ï¼Œå°è¯•ç›´æ¥è®¿é—®åç«¯
                if (!healthData) {
                    const response2 = await fetch('http://localhost:8000/health');
                    healthData = await response2.json();
                    endpoint = 'http://localhost:8000/health';
                }
                
                resultDiv.innerHTML = `
                    <div class="success">âœ… åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ</div>
                    <div style="margin-top: 10px;">
                        <strong>çŠ¶æ€:</strong> ${healthData.status}
                        <span class="status-badge online">åœ¨çº¿</span>
                    </div>
                    <div><strong>ç«¯ç‚¹:</strong> ${endpoint}</div>
                    <div><strong>è¿è¡Œæ—¶é—´:</strong> ${healthData.uptime?.toFixed(2)}ç§’</div>
                    <div><strong>ç¯å¢ƒ:</strong> ${healthData.environment}</div>
                    <div><strong>ç‰ˆæœ¬:</strong> ${healthData.version}</div>
                    <div><strong>æ•°æ®åº“:</strong> ${healthData.services?.database?.status || 'æœªçŸ¥'}</div>
                `;
                log('æœåŠ¡æ£€æŸ¥æˆåŠŸï¼Œä½¿ç”¨ç«¯ç‚¹: ' + endpoint, 'success');
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âŒ åç«¯æœåŠ¡è¿æ¥å¤±è´¥</div>
                    <div style="margin-top: 10px;">
                        <span class="status-badge offline">ç¦»çº¿</span>
                    </div>
                    <div style="margin-top: 10px; color: #666;">
                        é”™è¯¯: ${error.message}
                    </div>
                    <div style="margin-top: 10px; font-size: 12px; color: #999;">
                        æç¤º: è¯·ç¡®ä¿åç«¯æœåŠ¡è¿è¡Œåœ¨ http://localhost:8000
                    </div>
                `;
                log('æœåŠ¡æ£€æŸ¥å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æµ‹è¯•ç™»å½•
        async function testLogin() {
            const resultDiv = document.getElementById('loginResult');
            resultDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨ç™»å½•...';
            log('å¼€å§‹ç™»å½•æµ‹è¯•');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        email: 'testapi@finapp.com',
                        password: 'testapi123'
                    })
                });

                const data = await response.json();
                log('ç™»å½•å“åº”: ' + JSON.stringify(data));
                
                if (data.success && data.data && data.data.tokens && data.data.tokens.accessToken) {
                    authToken = data.data.tokens.accessToken;
                    localStorage.setItem('auth_token', authToken);
                    resultDiv.innerHTML = `
                        <div class="success">âœ… ç™»å½•æˆåŠŸï¼</div>
                        <div style="margin-top: 10px;">
                            <strong>ç”¨æˆ·:</strong> ${data.data.user.email}<br>
                            <strong>ç”¨æˆ·å:</strong> ${data.data.user.username}<br>
                            <strong>Token:</strong> ${authToken.substring(0, 50)}...<br>
                            <strong>è¿‡æœŸæ—¶é—´:</strong> ${data.data.tokens.expiresIn}ç§’<br>
                            <strong>çŠ¶æ€:</strong> å·²ä¿å­˜åˆ° localStorage
                        </div>
                    `;
                    log('ç™»å½•æˆåŠŸï¼ŒTokenå·²ä¿å­˜', 'success');
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">âŒ ç™»å½•å¤±è´¥</div>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    log('ç™»å½•å¤±è´¥: ' + JSON.stringify(data), 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>
                `;
                log('ç™»å½•è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ£€æŸ¥Token
        function checkToken() {
            const resultDiv = document.getElementById('loginResult');
            const token = localStorage.getItem('auth_token');
            
            if (token) {
                resultDiv.innerHTML = `
                    <div class="info">â„¹ï¸ Tokenå·²å­˜åœ¨</div>
                    <div style="margin-top: 10px;">
                        <strong>Token:</strong> ${token.substring(0, 50)}...<br>
                        <strong>é•¿åº¦:</strong> ${token.length} å­—ç¬¦
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="error">âŒ æœªæ‰¾åˆ°Tokenï¼Œè¯·å…ˆç™»å½•</div>
                `;
            }
        }

        // è·å–æ‰€æœ‰æ ‡ç­¾
        async function testGetTags() {
            const resultDiv = document.getElementById('tagsResult');
            resultDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨è·å–æ ‡ç­¾...';
            log('å¼€å§‹è·å–æµåŠ¨æ€§æ ‡ç­¾');
            
            const token = authToken || localStorage.getItem('auth_token');
            if (!token) {
                resultDiv.innerHTML = '<div class="error">âŒ è¯·å…ˆç™»å½•</div>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/liquidity-tags`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const tags = await response.json();
                log('APIè¿”å›æ•°æ®: ' + JSON.stringify(tags));
                
                if (Array.isArray(tags)) {
                    resultDiv.innerHTML = `
                        <div class="success">âœ… æˆåŠŸè·å– ${tags.length} ä¸ªæµåŠ¨æ€§æ ‡ç­¾</div>
                        <pre>${JSON.stringify(tags, null, 2)}</pre>
                    `;
                    log(`æˆåŠŸè·å– ${tags.length} ä¸ªæ ‡ç­¾`, 'success');
                    updateStats(tags);
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">âŒ è¿”å›æ•°æ®æ ¼å¼é”™è¯¯</div>
                        <pre>${JSON.stringify(tags, null, 2)}</pre>
                    `;
                    log('æ•°æ®æ ¼å¼é”™è¯¯', 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>
                `;
                log('è·å–æ ‡ç­¾å¤±è´¥: ' + error.message, 'error');
            }
        }

        // è·å–æ´»è·ƒæ ‡ç­¾
        async function testGetActiveTags() {
            const resultDiv = document.getElementById('tagsResult');
            resultDiv.innerHTML = '<div class="loading"></div> æ­£åœ¨è·å–æ´»è·ƒæ ‡ç­¾...';
            
            const token = authToken || localStorage.getItem('auth_token');
            if (!token) {
                resultDiv.innerHTML = '<div class="error">âŒ è¯·å…ˆç™»å½•</div>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/liquidity-tags`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const allTags = await response.json();
                const activeTags = allTags.filter(tag => tag.isActive);
                
                resultDiv.innerHTML = `
                    <div class="success">âœ… æˆåŠŸè·å–æ´»è·ƒæ ‡ç­¾</div>
                    <div style="margin-top: 10px;">
                        <strong>æ€»æ ‡ç­¾æ•°:</strong> ${allTags.length}<br>
                        <strong>æ´»è·ƒæ ‡ç­¾æ•°:</strong> ${activeTags.length}
                    </div>
                    <pre>${JSON.stringify(activeTags, null, 2)}</pre>
                `;
                updateStats(activeTags);
            } catch (error) {
                resultDiv.innerHTML = `
                    <div class="error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</div>
                `;
            }
        }

        // å¯è§†åŒ–æ˜¾ç¤ºæ ‡ç­¾
        async function showTagsVisual() {
            const displayDiv = document.getElementById('tagsDisplay');
            const token = authToken || localStorage.getItem('auth_token');
            
            if (!token) {
                displayDiv.innerHTML = '<div class="error">âŒ è¯·å…ˆç™»å½•</div>';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/liquidity-tags`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const tags = await response.json();
                
                displayDiv.innerHTML = '<h4 style="margin: 20px 0 10px 0;">æ ‡ç­¾å¯è§†åŒ–ï¼š</h4>';
                tags.forEach((tag, index) => {
                    displayDiv.innerHTML += `
                        <span class="tag" style="background-color: ${tag.color}">
                            ${index + 1}. ${tag.name}
                            ${tag.description ? `- ${tag.description}` : ''}
                        </span>
                    `;
                });
            } catch (error) {
                displayDiv.innerHTML = `<div class="error">âŒ æ˜¾ç¤ºå¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(tags) {
            const statsDiv = document.getElementById('statsDisplay');
            const activeCount = tags.filter(t => t.isActive).length;
            
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="number">${tags.length}</div>
                    <div class="label">æ€»æ ‡ç­¾æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="number">${activeCount}</div>
                    <div class="label">æ´»è·ƒæ ‡ç­¾</div>
                </div>
                <div class="stat-card">
                    <div class="number">${tags.length - activeCount}</div>
                    <div class="label">åœç”¨æ ‡ç­¾</div>
                </div>
            `;
        }

        // æŸ¥çœ‹LocalStorage
        function viewLocalStorage() {
            const debugDiv = document.getElementById('debugInfo');
            const token = localStorage.getItem('auth_token');
            const allKeys = Object.keys(localStorage);
            
            debugDiv.innerHTML = `
                <h4>LocalStorage å†…å®¹ï¼š</h4>
                <div style="margin-top: 10px;">
                    <strong>auth_token:</strong> ${token ? token.substring(0, 50) + '...' : 'æœªè®¾ç½®'}<br>
                    <strong>æ‰€æœ‰é”®:</strong> ${allKeys.length > 0 ? allKeys.join(', ') : 'æ— '}<br>
                    <strong>æ€»å¤§å°:</strong> ${JSON.stringify(localStorage).length} å­—èŠ‚
                </div>
            `;
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                localStorage.clear();
                authToken = '';
                allLogs = [];
                document.getElementById('debugInfo').innerHTML = '<div class="success">âœ… æ‰€æœ‰æ•°æ®å·²æ¸…é™¤</div>';
                log('æ¸…é™¤æ‰€æœ‰æ•°æ®', 'info');
            }
        }

        // å¤åˆ¶æ—¥å¿—
        function copyLogs() {
            const logsText = allLogs.join('\n');
            navigator.clipboard.writeText(logsText).then(() => {
                document.getElementById('debugInfo').innerHTML = '<div class="success">âœ… æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>';
            });
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
        window.onload = function() {
            log('æµ‹è¯•å·¥å…·å·²åŠ è½½');
            checkServices();
            viewLocalStorage();
        };
    </script>
</body>
</html>
