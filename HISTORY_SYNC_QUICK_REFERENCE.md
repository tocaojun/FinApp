# 历史数据同步快速参考

## 🎯 快速开始

### 回溯天数对照表

| 时间范围 | 天数 | 预计记录数* | 适用场景 |
|---------|------|-----------|---------|
| 1 个月 | 30 | ~20 | 最近数据补充 |
| 3 个月 | 90 | ~60 | 季度分析 |
| 半年 | 180 | ~120 | 半年度报告 |
| 1 年 | 365 | ~250 | 年度分析 |
| 2 年 | 730 | ~500 | 中期趋势 |
| 3 年 | 1095 | ~735 | 长期趋势 |
| 5 年 | 1825 | ~1250 | 历史回测 |
| 10 年 | 3650 | ~2500 | 完整历史 |

*预计记录数基于交易日计算（1年约250个交易日）

## 📝 操作步骤

### 前端界面操作（3 步）

```
1. 管理后台 → 价格管理 → API 同步 → 新建任务
2. 填写：名称、数据源、资产、回溯天数（1-3650）
3. 保存 → 执行 → 查看日志
```

### API 调用（2 步）

```bash
# 1. 创建任务
curl -X POST http://localhost:3001/api/price-sync/tasks \
  -H "Authorization: Bearer TOKEN" \
  -d '{"sync_days_back": 3650, ...}'

# 2. 执行任务
curl -X POST http://localhost:3001/api/price-sync/tasks/TASK_ID/execute \
  -H "Authorization: Bearer TOKEN"
```

## ⚡ 性能参考

| 回溯时间 | 单资产耗时 | 10资产耗时 | 100资产耗时 |
|---------|-----------|-----------|------------|
| 1 年 | ~0.6s | ~6s | ~60s |
| 3 年 | ~0.7s | ~7s | ~70s |
| 10 年 | ~1-2s | ~10-20s | ~100-200s |

## ⚠️ 注意事项

### API 限流
- Yahoo Finance: ~2000 请求/小时
- 建议单次同步 ≤ 50 个资产
- 大批量同步间隔 ≥ 30 分钟

### 数据验证
```sql
-- 快速检查数据范围
SELECT 
  MIN(price_date) as 开始日期,
  MAX(price_date) as 结束日期,
  COUNT(*) as 记录数
FROM finapp.asset_prices
WHERE asset_id = 'YOUR_ID' AND data_source = 'api';
```

### 常见错误
| 错误 | 原因 | 解决方案 |
|-----|------|---------|
| Rate limit exceeded | API 限流 | 等待 30 分钟 |
| No data returned | Symbol 不存在 | 检查 symbol 格式 |
| Invalid data structure | 数据格式错误 | 查看详细日志 |

## 🔧 分批同步策略

### 策略 A：按时间分批
```
批次 1: 最近 1 年  (365 天)   ← 优先
批次 2: 1-3 年前   (730 天)
批次 3: 3-5 年前   (1095 天)
批次 4: 5-10 年前  (1825 天)
```

### 策略 B：按资产分批
```
批次 1: 核心资产 10 个  × 10 年  ← 优先
批次 2: 重要资产 50 个  × 5 年
批次 3: 其他资产 100 个 × 1 年
```

## 📊 数据存储估算

| 资产数 | 10年数据 | 5年数据 | 1年数据 |
|-------|---------|---------|---------|
| 10 | 25,000 条 | 12,500 条 | 2,500 条 |
| 100 | 250,000 条 | 125,000 条 | 25,000 条 |
| 1000 | 2,500,000 条 | 1,250,000 条 | 250,000 条 |

## 🎓 示例场景

### 场景 1：新用户首次导入
```
目标：导入持仓资产的 3 年历史数据
步骤：
1. 选择所有持仓资产（假设 20 个）
2. 设置回溯天数：1095（3 年）
3. 执行同步
预计：~14,700 条记录，耗时 ~14 秒
```

### 场景 2：补全缺失数据
```
目标：补全 2020-2023 年的数据缺口
步骤：
1. 计算天数：2023-12-31 到 2020-01-01 = 1460 天
2. 设置回溯天数：1460
3. 关闭"覆盖已有数据"（避免重复）
4. 执行同步
```

### 场景 3：定期更新
```
目标：每周更新最新数据
步骤：
1. 创建定时任务
2. 设置回溯天数：7（1 周）
3. 开启"覆盖已有数据"
4. 设置 cron：0 0 18 * * 1（每周一 18:00）
```

## 🔍 故障排查

### 问题：同步后没有数据
```
检查清单：
□ 资产是否已上市？
□ Symbol 格式是否正确？
□ 数据源是否支持该资产？
□ 是否遇到 API 限流？
□ 查看同步日志的错误信息
```

### 问题：数据不完整
```
可能原因：
1. 停牌期间无数据
2. 资产上市时间晚于回溯起点
3. 数据源数据缺失

解决方案：
1. 检查资产 listing_date
2. 尝试其他数据源
3. 查看同步日志中的 skipped_count
```

## 📚 相关命令

```bash
# 查看同步任务
curl http://localhost:3001/api/price-sync/tasks

# 查看同步日志
curl http://localhost:3001/api/price-sync/logs

# 查看数据源
curl http://localhost:3001/api/price-sync/data-sources

# 删除测试数据
DELETE FROM finapp.asset_prices 
WHERE data_source = 'api' AND asset_id = 'YOUR_ID';
```

## 🎯 最佳实践总结

1. ✅ **首次同步**：从 1 年开始，逐步扩展
2. ✅ **分批处理**：单次 ≤ 50 个资产
3. ✅ **错误处理**：遇到限流等待 30 分钟
4. ✅ **数据验证**：同步后检查日期范围和记录数
5. ✅ **定期更新**：使用定时任务保持数据最新

---

**快速链接**：
- [详细指南](./LONG_HISTORY_SYNC_GUIDE.md)
- [修复报告](./PRICE_SYNC_FIX_COMPLETE.md)
- [限流规则](./YAHOO_FINANCE_RATE_LIMIT_GUIDE.md)
