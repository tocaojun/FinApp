# 市场字段修复快速测试指南

## 快速验证清单

### ✅ 前置条件
- [ ] 后端服务正在运行 (`npm run dev` in `backend/`)
- [ ] 前端服务正在运行 (`npm run dev` in `frontend/`)
- [ ] 已登录系统

### 🔍 测试步骤

#### 1. 打开数据同步页面
```
导航: 系统管理 → 数据同步
```

#### 2. 点击"新建任务"按钮
```
界面左上角有 "+ 新建任务" 按钮
```

#### 3. 验证市场字段内容
```
✓ 确认"市场"字段不为空
✓ 确认市场选项包含以下内容：

☐ 上海证券交易所 (SSE)
☐ 深圳证券交易所 (SZSE)  
☐ 香港交易所 (HKEX)
☐ 纽约证券交易所 (NYSE)
☐ 纳斯达克 (NASDAQ)
☐ 伦敦证券交易所 (LSE)
☐ 东京证券交易所 (TSE)
☐ 法兰克福证券交易所 (FWB)
```

#### 4. 尝试选择市场
```
点击市场字段
选择 "上海证券交易所"
确认选择成功（字段显示选中的市场）
```

#### 5. 验证其他字段
```
✓ 资产类型字段有选项
✓ 数据源字段有选项
```

---

## 预期结果

### ✅ 成功标志
- 市场字段显示完整的 8 个选项
- 能够正常选择任意市场
- 创建任务时市场值能被正确保存

### ❌ 失败标志
- 市场字段仍然为空
- 选项列表无法展开
- 无法保存市场选择

---

## 排障步骤

### 如果市场仍然为空

**步骤 1: 检查浏览器控制台**
```javascript
// 打开开发者工具 (F12)
// 查看 Console 标签
// 查找类似以下信息：
// "加载市场数据失败" 或 "Error loading markets"
```

**步骤 2: 检查后端 API**
```bash
# 在终端中执行
curl -H "Authorization: Bearer YOUR_TOKEN" \
  http://localhost:8000/api/markets

# 应该返回包含市场数据的 JSON 响应
```

**步骤 3: 清除缓存**
```bash
# 方法 1: 硬刷新浏览器
Ctrl + Shift + R (Windows/Linux)
或
Cmd + Shift + R (Mac)

# 方法 2: 清除 localStorage
# 在浏览器控制台执行
localStorage.clear()
// 然后刷新页面
```

**步骤 4: 重启服务**
```bash
# 重启后端
cd /Users/caojun/code/FinApp/backend
npm run dev

# 重启前端（新终端）
cd /Users/caojun/code/FinApp/frontend
npm run dev
```

---

## 数据库直接验证

### 查看市场数据
```bash
psql -h localhost -U finapp_user -d finapp_test

# 执行查询
SELECT code, name, country, currency, timezone 
FROM finapp.markets 
WHERE is_active = true 
ORDER BY code;
```

### 预期输出
```
code |         name         | country | currency |     timezone
-----+----------------------+---------+----------+------------------
FWB  | 法兰克福证券交易所   | DEU     | EUR      | Europe/Berlin
HKEX | 香港交易所           | HKG     | HKD      | Asia/Hong_Kong
LSE  | 伦敦证券交易所       | GBR     | GBP      | Europe/London
NASDAQ | 纳斯达克           | USA     | USD      | America/New_York
NYSE | 纽约证券交易所       | USA     | USD      | America/New_York
SSE  | 上海证券交易所       | CHN     | CNY      | Asia/Shanghai
SZSE | 深圳证券交易所       | CHN     | CNY      | Asia/Shanghai
TSE  | 东京证券交易所       | JPN     | JPY      | Asia/Tokyo
(8 rows)
```

---

## 自动化测试脚本

### 运行市场数据验证脚本
```bash
bash /Users/caojun/code/FinApp/scripts/verify-markets.sh
```

**预期结果**：
```
✓ 数据库连接成功
✓ 市场表存在
✓ 市场数据足够（至少 8 个）
✓ 市场 SSE 存在
✓ 市场 SZSE 存在
✓ 市场 HKEX 存在
...
✓ 所有检查通过，市场数据完整！
```

---

## 完整场景测试

### 场景 1: 创建同步任务并选择市场

**步骤**：
1. 进入 "系统管理" → "数据同步" → "同步任务" 标签
2. 点击 "+ 新建任务"
3. 填写任务信息：
   ```
   任务名称: 港股价格同步
   任务描述: 每日同步港股价格
   数据源: Yahoo Finance
   资产类型: 股票
   市场: 香港交易所 ✓ 需要显示
   调度方式: 手动
   回溯天数: 1
   ```
4. 点击 "确定" 保存

**预期结果**：
- ✅ 市场字段能够正常展开并选择
- ✅ 任务创建成功
- ✅ 任务列表中显示新创建的任务

### 场景 2: 编辑已有任务

**步骤**：
1. 进入已创建的任务
2. 点击 "编辑" 按钮
3. 验证市场字段已正确加载并显示之前选择的值

**预期结果**：
- ✅ 市场字段正确显示之前的选择
- ✅ 能够修改市场选择

---

## 性能指标

### 预期响应时间
| 操作 | 预期时间 | 要求 |
|------|---------|------|
| 打开新建任务对话框 | < 1 秒 | ✓ |
| 展开市场下拉菜单 | < 500ms | ✓ |
| 选择市场 | < 200ms | ✓ |
| 保存任务 | < 2 秒 | ✓ |

---

## 成功案例

### ✅ 正常工作的表现
```
【新建同步任务】
├─ 任务名称: 港股价格同步
├─ 数据源: Yahoo Finance ✓
├─ 资产类型: 股票 ✓
├─ 市场: 香港交易所 ✓ [显示 8 个选项]
└─ 状态: 任务创建成功

【验证结果】
✓ 市场字段有内容
✓ 能够正常选择
✓ 选择被正确保存
```

---

## 常见问题排障

| 问题 | 原因 | 解决方案 |
|------|------|--------|
| 市场为空 | 前端加载失败 | 刷新页面、检查浏览器控制台 |
| 市场加载缓慢 | 网络延迟 | 已改进超时设置，应该快速加载 |
| 选择市场后丢失 | API 保存失败 | 检查后端日志、检查网络连接 |
| 编辑时市场为空 | 数据加载问题 | 重新加载页面 |

---

## 反馈流程

如果测试仍有问题，请提供以下信息：

1. **浏览器控制台错误**
   ```javascript
   // 右键 → 检查 → Console 标签
   // 复制所有红色错误信息
   ```

2. **后端日志**
   ```bash
   # 查看后端启动输出的错误信息
   # 特别关注 API 路由和数据库查询错误
   ```

3. **网络请求信息**
   ```javascript
   // 在浏览器 DevTools → Network 标签
   // 选中 /api/markets 请求
   // 查看 Response 和 Status Code
   ```

---

**测试日期**: 2025-11-07  
**修复版本**: v1.0  
**测试状态**: ✅ 已验证  
