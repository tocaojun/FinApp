# 汇率同步功能 - 快速开始指南

## 📋 功能一览

在数据同步页面新增**汇率同步** Tab，支持：
- ✅ 查看历史汇率数据
- ✅ 实时刷新汇率
- ✅ 导入历史汇率数据
- ✅ 手动添加单条汇率
- ✅ 删除汇率记录
- ✅ 统计汇率信息

---

## 🚀 快速开始

### 1. 访问汇率同步页面

```
1. 进入后台管理系统
2. 左侧菜单 → 数据同步
3. 点击"汇率同步" Tab
```

### 2. 查看汇率统计

页面顶部显示四张卡片：

| 卡片 | 含义 |
|------|------|
| 总汇率记录 | 数据库中所有汇率记录总数 |
| 货币对数 | 存储了汇率的不同货币对组合数 |
| 数据源数 | 汇率数据来自多少个不同数据源 |
| 最后更新 | 上次更新汇率的时间 |

### 3. 刷新汇率

```
1. 点击"刷新当前汇率"按钮
2. 系统从配置的数据源获取最新汇率
3. 等待刷新完成（异步处理）
4. 看到成功提示后，列表自动更新
```

**支持的数据源**:
- exchangerate-api.com
- fixer.io
- currencylayer.com

### 4. 导入历史汇率

```
步骤：
1. 点击"导入历史汇率"按钮
2. 填写表单：
   ├─ 选择源货币（如 USD）
   ├─ 选择目标货币（如 CNY）
   ├─ 选择日期范围（可用快速选择）
   └─ 输入回溯天数（可选，默认 365）
3. 点击"确定"开始导入
4. 等待后台处理完成
```

**快速选择**:
- 最近 30 天
- 最近 90 天
- 最近 1 年

### 5. 手动添加汇率

```
步骤：
1. 点击"手动添加汇率"按钮
2. 填写表单：
   ├─ 选择源货币
   ├─ 选择目标货币
   ├─ 选择日期
   └─ 输入汇率值
3. 点击"确定"保存
```

**示例**:
- 源货币: USD (美元)
- 目标货币: CNY (人民币)
- 日期: 2025-11-08
- 汇率: 7.256000

### 6. 查看汇率列表

表格显示以下信息：

| 列名 | 说明 |
|------|------|
| 货币对 | 蓝色标签显示，格式为 FROM/TO |
| 汇率 | 6 位小数精度 |
| 日期 | YYYY-MM-DD 格式 |
| 数据源 | orange=手动输入，green=自动获取 |
| 创建时间 | 完整的时间戳 |
| 操作 | 删除按钮 |

### 7. 删除汇率

```
1. 在汇率列表找到要删除的记录
2. 点击该行的"删除"按钮
3. 确认对话框中点击"确定"
4. 记录被删除
```

---

## 💡 常见问题

### Q: 汇率数据的精度是多少？
**A**: 小数点后 6 位，存储为 DECIMAL(20, 8)

### Q: 为什么刷新汇率没有反应？
**A**: 检查以下几点：
- 后端服务是否正常运行
- 是否配置了数据源的 API Key
- 网络连接是否正常

### Q: 能批量导入汇率吗？
**A**: 当前支持按日期范围导入（调用 API）。可通过点击"导入历史汇率"设置日期范围。

### Q: 相同货币对、相同日期的汇率能保存多条吗？
**A**: 不能。系统对 (from_currency, to_currency, rate_date) 组合设置了唯一性约束。
- 新增时如果存在相同记录，会提示错误
- 导入时支持选择更新或跳过

### Q: 汇率支持哪些货币？
**A**: 系统支持国际标准的 3 字符货币代码，常见的包括：
- USD (美元)
- EUR (欧元)
- GBP (英镑)
- JPY (日元)
- CNY (人民币)
- HKD (港币)
- SGD (新加坡币)
- AUD (澳元)

### Q: 删除的汇率能恢复吗？
**A**: 删除后无法恢复。删除前会有确认对话框，请谨慎操作。

### Q: 汇率按什么顺序排列？
**A**: 按日期降序排列（最新的在前）

---

## 📊 数据说明

### 汇率存储

```sql
-- 表结构
FROM_CURRENCY  TO_CURRENCY  RATE_DATE   RATE        DATA_SOURCE
USD            CNY          2025-11-08  7.256000    api
EUR            USD          2025-11-08  1.090000    api
USD            HKD          2025-11-08  7.800000    manual
```

### 日期精度

- 最小单位：**天**（DATE 类型）
- 不存储时分秒
- 同一货币对同一天只能有一条记录

### 数据源标记

| 标记 | 说明 |
|------|------|
| manual | 手动输入 |
| api | 从 API 自动获取 |
| excel | 从 Excel 导入 |
| manual | 其他手动来源 |

---

## 🔧 功能特性

### 自动计算
- ✅ 自动计算每行的"最后更新"时间
- ✅ 自动统计货币对数量
- ✅ 自动统计数据源数量

### 验证规则
- ❌ 源货币和目标货币不能相同
- ❌ 汇率值必须大于 0
- ❌ 日期不能为空

### 性能优化
- ✅ 使用了索引加速查询
- ✅ 分页显示（每页 20 条）
- ✅ 异步加载数据

---

## 🛠 开发者信息

### 文件位置

```
前端文件：
├── frontend/src/services/exchangeRateSyncApi.ts
└── frontend/src/pages/admin/DataSync/
    ├── index.tsx (已修改)
    └── ExchangeRateSync.tsx (新增)

后端文件：
├── backend/src/services/ExchangeRateService.ts
├── backend/src/services/ExchangeRateUpdateService.ts
├── backend/src/controllers/ExchangeRateController.ts
└── backend/src/routes/exchangeRates.ts
```

### API 端点

```
GET    /api/exchange-rates                   # 查询汇率列表
POST   /api/exchange-rates                   # 创建汇率
DELETE /api/exchange-rates/:id              # 删除汇率
GET    /api/exchange-rates/statistics       # 获取统计信息
GET    /api/exchange-rates/currencies       # 获取货币列表
POST   /api/exchange-rates/refresh          # 刷新汇率
POST   /api/exchange-rates/import-historical # 导入历史汇率
```

### 关键依赖

```typescript
import dayjs from 'dayjs'                    // 日期处理
import axios from 'axios'                    // HTTP 请求
import { Button, Table, Modal, Form, ... } from 'antd'  // UI 组件
```

---

## 📝 使用示例

### 场景 1: 获取 USD/CNY 最近一个月的历史汇率

```
1. 点击"导入历史汇率"
2. 源货币: USD
3. 目标货币: CNY
4. 日期范围: 最近 30 天
5. 点击"确定"
```

### 场景 2: 手动录入特定日期的汇率

```
1. 点击"手动添加汇率"
2. 源货币: EUR
3. 目标货币: USD
4. 日期: 2025-11-01
5. 汇率: 1.090000
6. 点击"确定"
```

### 场景 3: 更新汇率数据

```
1. 点击"刷新当前汇率"
2. 等待系统从 API 获取最新数据
3. 查看汇率是否有变化
```

---

## ⚠️ 注意事项

### 数据安全
- ✅ 删除操作需要确认
- ✅ 导入时支持去重和更新选择
- ✅ 自动约束防止重复数据

### 性能考虑
- ⚠️ 大批量导入（>1000条）可能需要较长时间
- ⚠️ 第一次加载汇率列表可能较慢
- ⚠️ 建议在业务低峰期导入历史数据

### 数据一致性
- ✅ 使用数据库事务确保数据一致性
- ✅ 重复导入时支持跳过或更新
- ✅ 支持回滚操作

---

## 📞 获取帮助

如遇问题，请检查：

1. **后端是否运行**
   ```bash
   ps aux | grep node
   ```

2. **API 是否可访问**
   ```bash
   curl http://localhost:3000/api/exchange-rates
   ```

3. **检查浏览器控制台**
   - 按 F12 打开开发者工具
   - 查看 Console 标签页的错误信息
   - 查看 Network 标签页的 API 请求

---

**最后更新**: 2025-11-08  
**版本**: v1.0  
**状态**: 可用 ✅
