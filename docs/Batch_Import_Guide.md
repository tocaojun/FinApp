# 价格批量导入功能使用指南

## 📋 功能概述

价格批量导入功能允许用户通过 Excel 文件一次性导入大量价格数据，适用于：
- 历史价格数据迁移
- 定期批量更新价格
- 从外部系统导入价格数据

## 🎯 功能特性

### 1. 模板下载
- 提供标准 Excel 模板
- 包含示例数据
- 字段说明清晰

### 2. 数据验证
- 产品代码验证（自动匹配系统中的产品）
- 日期格式验证
- 价格逻辑验证（最高价 ≥ 收盘价 ≥ 最低价）
- 必填字段检查

### 3. 导入预览
- 显示所有导入记录
- 标记有效/无效记录
- 显示错误原因
- 统计信息展示

### 4. 批量保存
- 仅导入有效记录
- 使用 UPSERT 逻辑（存在则更新，不存在则插入）
- 事务处理，确保数据一致性

## 📝 使用步骤

### 步骤 1: 下载模板

1. 进入"价格管理中心" → "批量导入"标签页
2. 点击"下载导入模板"按钮
3. 保存模板文件到本地

### 步骤 2: 填写数据

在 Excel 模板中填写价格数据，字段说明如下：

| 字段名称 | 是否必填 | 格式说明 | 示例 |
|---------|---------|---------|------|
| 产品代码 | ✅ 必填 | 与系统中的产品代码完全一致 | 00700, BILI |
| 产品名称 | ⭕ 可选 | 仅用于参考，不影响导入 | 腾讯控股 |
| 价格日期 | ✅ 必填 | YYYY-MM-DD 格式 | 2025-01-15 |
| 收盘价 | ✅ 必填 | 数字，最多4位小数 | 350.50 |
| 开盘价 | ⭕ 可选 | 数字，最多4位小数 | 348.00 |
| 最高价 | ⭕ 可选 | 数字，最多4位小数 | 352.00 |
| 最低价 | ⭕ 可选 | 数字，最多4位小数 | 347.50 |
| 币种 | ⭕ 可选 | 如不填写，使用产品默认币种 | HKD, USD, CNY |

**注意事项：**
- 产品代码必须与系统中的产品代码完全一致（区分大小写）
- 日期格式必须为 YYYY-MM-DD
- 收盘价必须大于 0
- 如果填写了最高价和最低价，必须满足：最低价 ≤ 开盘价/收盘价 ≤ 最高价

### 步骤 3: 上传文件

1. 点击"选择 Excel 文件"按钮
2. 选择填写好的 Excel 文件
3. 系统自动解析并验证数据

**文件要求：**
- 支持格式：.xlsx, .xls
- 文件大小：不超过 5MB
- 记录数量：单次最多 1000 条

### 步骤 4: 检查验证结果

系统会自动验证所有记录，并显示：
- 总记录数
- 有效记录数
- 无效记录数
- 有效率

**验证规则：**
1. 产品代码是否存在于系统中
2. 价格日期格式是否正确
3. 收盘价是否大于 0
4. 价格逻辑是否合理

**处理无效记录：**
- 查看错误信息列，了解具体错误原因
- 修正 Excel 文件中的错误数据
- 重新上传文件

### 步骤 5: 确认导入

1. 检查有效记录数据是否正确
2. 点击"导入 X 条有效记录"按钮
3. 确认导入操作
4. 等待导入完成

## 📊 模板示例

```
产品代码 | 产品名称 | 价格日期   | 收盘价  | 开盘价  | 最高价  | 最低价  | 币种
--------|---------|-----------|--------|--------|--------|--------|------
00700   | 腾讯控股 | 2025-01-15| 350.50 | 348.00 | 352.00 | 347.50 | HKD
03690   | 美团-W   | 2025-01-15| 125.80 | 124.50 | 126.20 | 124.00 | HKD
BILI    | 哔哩哔哩 | 2025-01-15| 18.50  | 18.20  | 18.80  | 18.10  | USD
```

## ⚠️ 常见问题

### 1. 产品代码不存在

**错误信息：** "产品代码 XXX 不存在"

**解决方法：**
- 检查产品代码是否正确（注意大小写）
- 确认该产品是否已在系统中创建
- 如果产品不存在，需要先在"产品管理"中创建产品

### 2. 日期格式错误

**错误信息：** "价格日期格式无效"

**解决方法：**
- 确保日期格式为 YYYY-MM-DD
- 不要使用 Excel 的日期格式，使用文本格式
- 示例：2025-01-15（正确）、2025/01/15（错误）

### 3. 价格逻辑错误

**错误信息：** "最高价不能低于最低价" 或 "收盘价应在最高价和最低价之间"

**解决方法：**
- 检查价格数据是否合理
- 确保：最低价 ≤ 开盘价 ≤ 最高价
- 确保：最低价 ≤ 收盘价 ≤ 最高价

### 4. 文件解析失败

**错误信息：** "解析文件失败，请检查文件格式"

**解决方法：**
- 确保使用提供的模板
- 不要修改表头字段名称
- 确保文件格式为 .xlsx 或 .xls
- 检查文件是否损坏

### 5. 导入失败

**错误信息：** "导入失败"

**解决方法：**
- 检查网络连接
- 确认是否有导入权限
- 查看浏览器控制台错误信息
- 联系系统管理员

## 🔧 技术细节

### 数据处理流程

```
1. 文件上传
   ↓
2. Excel 解析（使用 xlsx 库）
   ↓
3. 数据验证
   - 产品代码查询
   - 日期格式验证
   - 价格逻辑验证
   ↓
4. 显示验证结果
   ↓
5. 用户确认
   ↓
6. 批量保存（调用 /api/assets/prices/bulk）
   ↓
7. 显示导入结果
```

### API 调用

**端点：** `POST /api/assets/prices/bulk`

**请求体：**
```json
{
  "updates": [
    {
      "assetId": "uuid",
      "priceDate": "2025-01-15",
      "closePrice": 350.50,
      "openPrice": 348.00,
      "highPrice": 352.00,
      "lowPrice": 347.50,
      "currency": "HKD",
      "dataSource": "IMPORT"
    }
  ]
}
```

**响应：**
```json
{
  "success": true,
  "data": {
    "totalRecords": 100,
    "successCount": 100,
    "errorCount": 0,
    "errors": []
  },
  "message": "成功保存 100 条价格记录"
}
```

### 数据源标记

批量导入的数据会被标记为 `dataSource: 'IMPORT'`，以区分其他来源的数据：
- `MANUAL`: 手动录入
- `IMPORT`: 批量导入
- `API`: API 自动同步

## 📈 性能优化

### 当前限制
- 单次最多导入 1000 条记录
- 文件大小不超过 5MB
- 验证过程在前端进行，减轻服务器压力

### 优化建议
- 如需导入大量数据（>1000条），建议分批导入
- 导入前先在 Excel 中检查数据质量
- 避免在高峰期进行大批量导入

## 🔐 权限要求

使用批量导入功能需要以下权限：
- `price:import` - 价格导入权限
- `asset:read` - 资产读取权限（用于验证产品代码）

## 📚 相关文档

- [价格更新功能重新设计](./Price_Update_Redesign.md)
- [价格管理测试清单](./Price_Management_Test_Checklist.md)
- [价格管理界面更新说明](./Price_Management_UI_Update.md)

## 🆘 技术支持

如遇到问题，请：
1. 查看本文档的"常见问题"部分
2. 检查浏览器控制台错误信息
3. 联系系统管理员或技术支持团队

---

**最后更新**: 2025-10-26  
**版本**: v1.0
