# 密码修改功能说明

## 问题原因

前端密码验证规则与后端不一致:
- **前端**(修复前): 只验证长度 ≥ 8位
- **后端**: 严格验证密码强度(大小写+数字+特殊字符)

导致用户输入简单密码时,前端验证通过,但后端拒绝,显示"修改密码失败"。

## 修复内容

### 1. 前端密码验证规则(SettingsPage.tsx)

**修复前**:
```tsx
rules={[
  { required: true, message: '请输入新密码' },
  { min: 8, message: '密码长度至少8位' }
]}
```

**修复后**:
```tsx
rules={[
  { required: true, message: '请输入新密码' },
  { min: 8, message: '密码长度至少8位' },
  {
    pattern: /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/,
    message: '密码必须包含大写字母、小写字母、数字和特殊字符(@$!%*?&)'
  }
]}
```

### 2. 添加密码要求提示

在密码输入框下方显示:
```
密码要求：至少8位，包含大写字母、小写字母、数字和特殊字符(@$!%*?&)
```

### 3. 改进错误提示

根据后端返回的错误代码显示友好的错误信息:

| 错误代码 | 错误信息 |
|---------|---------|
| `INVALID_PASSWORD` | 当前密码不正确 |
| `WEAK_PASSWORD` | 新密码强度不够：必须包含大写字母、小写字母、数字和特殊字符 |
| `SAME_PASSWORD` | 新密码不能与当前密码相同 |

## 密码要求规则

### ✅ 有效密码示例
- `Admin123!` ✅
- `MyPass@2024` ✅
- `Test$ecure1` ✅
- `Pa$$w0rd` ✅

### ❌ 无效密码示例
- `admin123` ❌ (缺少大写字母和特殊字符)
- `ADMIN123!` ❌ (缺少小写字母)
- `Admin@abc` ❌ (缺少数字)
- `Admin123` ❌ (缺少特殊字符)
- `Ab1!` ❌ (长度不足8位)

## 密码强度检查逻辑

```regex
^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$
```

分解说明:
- `^` - 字符串开始
- `(?=.*[a-z])` - 至少包含一个小写字母
- `(?=.*[A-Z])` - 至少包含一个大写字母
- `(?=.*\d)` - 至少包含一个数字
- `(?=.*[@$!%*?&])` - 至少包含一个特殊字符
- `[A-Za-z\d@$!%*?&]{8,}` - 只允许这些字符,长度至少8位
- `$` - 字符串结束

## 部署步骤

在服务器上执行:

```bash
cd /opt/finapp/releases/$(ls -t /opt/finapp/releases | grep -E '^[0-9]{8}_[0-9]{6}$' | head -1)
git config core.fileMode false
git reset --hard HEAD
git pull origin master
chmod +x scripts/*.sh
bash scripts/redeploy-frontend-ubuntu.sh
```

## 测试步骤

### 1. 测试无效密码(应该被前端拦截)

在设置页面点击"修改密码",输入:
- 当前密码: `testapi123` (或你的实际密码)
- 新密码: `admin123` (无效:缺少大写和特殊字符)

**预期结果**: 
- ❌ 前端显示错误: "密码必须包含大写字母、小写字母、数字和特殊字符(@$!%*?&)"
- ✅ 不会发送到后端

### 2. 测试有效密码(应该成功)

输入:
- 当前密码: `testapi123`
- 新密码: `TestApi@2024`
- 确认密码: `TestApi@2024`

**预期结果**:
- ✅ 前端验证通过
- ✅ 后端验证通过
- ✅ 显示: "密码修改成功"
- ✅ Modal关闭

### 3. 测试错误的当前密码

输入:
- 当前密码: `WrongPass123!`
- 新密码: `TestApi@2024`
- 确认密码: `TestApi@2024`

**预期结果**:
- ✅ 前端验证通过
- ❌ 后端验证失败
- ✅ 显示: "当前密码不正确"

### 4. 测试新密码与当前密码相同

输入:
- 当前密码: `testapi123`
- 新密码: `testapi123`
- 确认密码: `testapi123`

**预期结果**:
- ❌ 前端验证失败(格式不符合)
- 或者后端返回: "新密码不能与当前密码相同"

## 注意事项

1. **现有用户密码**: 如果现有测试账户的密码不符合新规则,仍然可以使用旧密码登录,但修改密码时必须使用符合新规则的密码。

2. **特殊字符限制**: 只允许 `@$!%*?&` 这些特殊字符,其他特殊字符(如 `#^()-_+=[]{}`)不被接受。

3. **错误信息**: 前端会实时验证,用户在输入时就能看到提示,不需要提交后才知道密码不符合要求。

## 相关文件

- 前端: `frontend/src/pages/settings/SettingsPage.tsx`
- 后端: `backend/src/services/AuthService.ts` (changePassword方法)
- 后端: `backend/src/controllers/AuthController.ts` (changePassword控制器)

---

**修复日期**: 2025-12-09  
**版本**: v1.0  
**状态**: ✅ 已修复并测试
