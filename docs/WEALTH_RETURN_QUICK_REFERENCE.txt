================================================================================\n财富产品收益追踪 - 快速参考指南\n================================================================================\n\n【问题】理财产品的预期收益率和实际收益率的偏差如何解决？\n\n================================================================================\n1. 核心概念\n================================================================================\n\n【分红型产品】(DIVIDEND)\n  定义：   按照约定周期支付分红的产品\n  特点：   本金相对保证，收益浮动\n  计算：   实际收益 = 累计分红金额\n  偏差：   实际分红 vs 预期年化收益率\n\n【净值型产品】(NAV)\n  定义：   基于基金净值波动的产品\n  特点：   无本金保证，高风险高收益\n  计算：   实际收益 = (赎回净值 - 认购净值) × 份数\n  偏差：   实际收益率 vs 预期年化收益率\n\n================================================================================\n2. 预期 vs 实际收益偏差分类\n================================================================================\n\n【正常偏差】 (NORMAL) - 偏差率 ≤ ±2%\n  原因：  正常的市场波动\n  处理：  无需处理，继续持有\n  建议：  定期检查，持续监控\n\n【预警偏差】 (WARNING) - 偏差率 2% ~ 5%\n  原因：  市场波动较大、费用影响等\n  处理：  需要关注产品表现\n  建议：  核查费用、对比同类产品、咨询产品经理\n\n【严重偏差】 (ALERT) - 偏差率 > 5%\n  原因：  产品经理操作不力、风险事件等\n  处理：  需要立即处理\n  建议：  咨询产品经理、考虑赎回、切换产品\n\n================================================================================\n3. 常见偏差原因分析\n================================================================================\n\n【分红型产品常见原因】\n\n1. 分红延迟\n   - 原因：产品兑付流程、资金结算延迟\n   - 处理：记录实际分红日期，调整预期\n   - 监控：超过30天未分红 → 预警\n\n2. 分红率浮动\n   - 原因：产品实际收益波动\n   - 处理：获取历史分红数据，计算实际收益率\n   - 监控：对比历史平均分红率\n\n3. 费用高于预期\n   - 原因：管理费、托管费、销售费等\n   - 处理：核对产品说明书中的费用条款\n   - 监控：监控费用占比是否合理\n\n4. 提前赎回\n   - 原因：提前赎回需支付赎回费\n   - 处理：计算赎回费用影响\n   - 监控：明确锁定期和赎回条件\n\n【净值型产品常见原因】\n\n1. 市场波动\n   - 原因：股市/债市波动影响基金净值\n   - 处理：实时跟踪NAV历史\n   - 监控：日度NAV变化率\n\n2. 基金经理能力\n   - 原因：投资决策不佳\n   - 处理：对比同类基金表现\n   - 监控：年化收益率 vs 基准指数\n\n3. 隐含费用\n   - 原因：交易费用、申购赎回费差异\n   - 处理：获取完整的费用明细\n   - 监控：总费用率是否透明\n\n4. 时间错配\n   - 原因：申购/赎回时间不同，NAV价格不同\n   - 处理：按照成交日期的NAV计算\n   - 监控：记录准确的申购/赎回日期和NAV\n\n================================================================================\n4. 数据库操作\n================================================================================\n\n【记录购买】\n  INSERT INTO finapp.wealth_product_transactions (\n    asset_id, transaction_type, transaction_date, amount, \n    quantity, nav_per_share, status\n  ) VALUES (\n    '<asset_id>', 'PURCHASE', '2025-11-08', 100000,\n    10000, 10.00, 'COMPLETED'\n  );\n\n【记录分红】\n  INSERT INTO finapp.wealth_product_transactions (\n    asset_id, transaction_type, transaction_date, amount, \n    dividend_rate, status\n  ) VALUES (\n    '<asset_id>', 'DIVIDEND', '2025-11-08', 500,\n    0.50, 'COMPLETED'\n  );\n\n【记录净值历史】\n  INSERT INTO finapp.wealth_product_nav_history (\n    asset_id, nav_date, nav_per_share, daily_return,\n    holding_period_return\n  ) VALUES (\n    '<asset_id>', '2025-11-08', 10.50, 0.50, 5.0\n  );\n\n【查询偏差分析】\n  SELECT * FROM finapp.vw_deviation_analysis\n  WHERE asset_id = '<asset_id>';\n\n【查询收益统计】\n  SELECT * FROM finapp.vw_wealth_product_returns\n  WHERE status = 'ALERT';\n\n================================================================================\n5. API 接口调用\n================================================================================\n\n【获取产品收益】\n  GET /api/assets/{assetId}/wealth-return\n  \n  响应:\n  {\n    \"productType\": \"DIVIDEND\",\n    \"expectedReturn\": 50000,\n    \"actualReturn\": 48500,\n    \"deviation\": -1500,\n    \"deviationRatio\": -3.0,\n    \"status\": \"WARNING\",\n    \"lastUpdated\": \"2025-11-08T10:00:00Z\"\n  }\n\n【记录交易】\n  POST /api/assets/{assetId}/wealth-transaction\n  \n  请求体:\n  {\n    \"type\": \"DIVIDEND\",\n    \"date\": \"2025-11-08\",\n    \"amount\": 500,\n    \"dividendRate\": 0.50,\n    \"notes\": \"Q4分红\"\n  }\n\n【获取偏差分析】\n  GET /api/assets/{assetId}/deviation-analysis\n  \n  响应:\n  {\n    \"level\": \"WARNING\",\n    \"threshold\": 5,\n    \"reasons\": [\"分红延迟\", \"费用高于预期\"],\n    \"recommendation\": \"建议核查产品表现和费用\",\n    \"trend\": [-1.5, -1.2, -2.0, -2.5, -3.0]\n  }\n\n================================================================================\n6. 实现检查清单\n================================================================================\n\n数据库\n  ☐ 执行迁移脚本 up.sql\n  ☐ 验证表结构创建成功\n  ☐ 创建索引以提高查询性能\n  ☐ 验证视图可正常查询\n\n后端服务\n  ☐ 实现 WealthProductReturnService\n  ☐ 添加收益计算方法\n  ☐ 添加交易记录方法\n  ☐ 添加偏差分析方法\n  ☐ 处理错误和异常\n\nAPI 接口\n  ☐ POST /wealth-transaction\n  ☐ GET /wealth-return\n  ☐ GET /deviation-analysis\n  ☐ 实现分页和过滤\n\n前端展示\n  ☐ 创建收益对比面板\n  ☐ 展示预期 vs 实际\n  ☐ 显示偏差级别指示器\n  ☐ 提供原因分析和建议\n  ☐ 支持导出报告\n\n监控告警\n  ☐ 设置日度监控任务\n  ☐ 配置偏差预警规则\n  ☐ 实现自动告警通知\n  ☐ 记录告警日志\n\n================================================================================\n7. 示例场景\n================================================================================\n\n【场景1：分红型产品分红延迟】\n  问题：  预计11月1日分红，现在已11月8日还未分红\n  处理：  \n    1. 记录延迟信息到 wealth_product_transactions\n    2. 更新 wealth_product_details 的 total_dividends_received\n    3. 触发 DIVIDEND_DELAY 告警\n    4. 建议用户联系产品经理\n\n【场景2：净值型产品收益大幅下跌】\n  问题：  产品净值在一周内下跌5%\n  处理：  \n    1. 记录每日NAV变化到 wealth_product_nav_history\n    2. 计算每日涨幅和累计收益率\n    3. 对比预期年化收益率，识别偏差\n    4. 如果偏差 > 5%，触发 ALERT 告警\n    5. 建议用户评估风险承受能力\n\n【场景3：分红型产品实际分红率 < 预期】\n  问题：  预期年化5%，实际每月仅分0.3%（年3.6%）\n  处理：  \n    1. 按历史分红数据计算实际年化收益率 = 3.6%\n    2. 计算偏差 = (3.6% - 5%) / 5% = -28%\n    3. 触发 ALERT 告警\n    4. 分析原因：\n       - 基金经理投资不力？\n       - 市场环境恶劣？\n       - 费用高于预期？\n    5. 建议用户考虑赎回并切换产品\n\n================================================================================\n8. 性能优化建议\n================================================================================\n\n【索引优化】\n  - 在 asset_id 和 transaction_date 上创建复合索引\n  - 在 asset_id 和 nav_date 上创建唯一索引\n  - 定期分析慢查询日志\n\n【查询优化】\n  - 使用物化视图存储频繁查询结果\n  - 设置合理的数据保留期（如保留2年数据）\n  - 采用分区存储大表\n\n【缓存策略】\n  - 缓存最新的NAV数据（10分钟更新一次）\n  - 缓存偏差分析结果（每小时更新一次）\n  - 缓存产品基本信息\n\n================================================================================\n9. 常见问题\n================================================================================\n\nQ: 如何处理分红再投资？\nA: 在 wealth_product_details 中设置 dividend_reinvestment = true\n   自动生成一条 DIVIDEND 交易后立即生成 PURCHASE 交易\n\nQ: 如何计算加权收益率？\nA: 使用时间加权收益率 (TWR) = (期末值 / 期初值)^(365/天数) - 1\n\nQ: 如何处理多币种产品？\nA: 在 wealth_product_details 中设置 nav_currency\n   记录交易时同时记录汇率信息\n\nQ: 如何追踪赎回费用影响？\nA: 在 wealth_product_transactions 中记录 REDEMPTION 类型\n   包含 fee_amount 和 fee_description\n\nQ: 产品如何对标同类产品？\nA: 创建产品对比视图，使用同类产品平均收益率作为基准\n   计算相对超额收益\n\n================================================================================\n10. 相关文档\n================================================================================\n\n详细文档：\n  - /docs/WEALTH_PRODUCT_RETURN_TRACKING.md（完整设计文档）\n  - /backend/src/services/WealthProductReturnService.ts（服务实现）\n  - /backend/migrations/011_wealth_product_returns/（数据库脚本）\n\n相关功能：\n  - AssetDetailsService（资产详情服务）\n  - PriceSyncService（价格同步服务）\n  - AssetManagement（前端资产管理页面）\n\n================================================================================\n版本：1.0\n更新日期：2025-11-08\n适用范围：分红型理财产品、净值型理财产品\n================================================================================\n