# ä¼˜åŒ–æ‰§è¡Œè·¯çº¿å›¾

## ğŸ“… 4 å‘¨ä¼˜åŒ–è®¡åˆ’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 1 å‘¨ï¼šåŸºç¡€ä¼˜åŒ–ï¼ˆæ”¶ç›Š 80%ï¼Œæ—¶é—´ 1 å‘¨ï¼‰                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚ Mon (P1-1) [15min]  æƒé™ç¼“å­˜ä¼˜åŒ–                                  â”‚
â”‚  â””â”€ ä¿®æ”¹ï¼šbackend/src/services/PermissionService.ts              â”‚
â”‚  â””â”€ æ•ˆæœï¼šæƒé™æŸ¥è¯¢ 50ms â†’ 5ms                                   â”‚
â”‚  â””â”€ é£é™©ï¼šä½                                                     â”‚
â”‚                                                                   â”‚
â”‚ Tue (P1-3) [10min]  å‰ç«¯è¶…æ—¶æ§åˆ¶                                  â”‚
â”‚  â””â”€ ä¿®æ”¹ï¼šfrontend/src/services/api.ts                           â”‚
â”‚  â””â”€ æ•ˆæœï¼šæ— é™ç­‰å¾… â†’ 30s è¶…æ—¶æç¤º                               â”‚
â”‚  â””â”€ é£é™©ï¼šä½                                                     â”‚
â”‚                                                                   â”‚
â”‚ Wed (P1-4) [5min]   æ•°æ®åº“ç´¢å¼•                                    â”‚
â”‚  â””â”€ ä¿®æ”¹ï¼šPostgreSQL æ•°æ®åº“                                      â”‚
â”‚  â””â”€ æ•ˆæœï¼šæƒé™æŸ¥è¯¢åŠ é€Ÿ 20%                                      â”‚
â”‚  â””â”€ é£é™©ï¼šæ—                                                      â”‚
â”‚                                                                   â”‚
â”‚ Thu-Fri (P1-2) [4h] N+1 æŸ¥è¯¢ä¼˜åŒ–ï¼ˆæ ¸å¿ƒå·¥ä½œï¼‰                     â”‚
â”‚  â””â”€ ä¿®æ”¹ï¼šbackend/src/services/PortfolioService.ts               â”‚
â”‚  â””â”€        backend/src/services/HoldingService.ts                â”‚
â”‚  â””â”€ æ•ˆæœï¼š500-2000ms â†’ 50-100msï¼ˆ10 å€åŠ é€Ÿï¼‰                    â”‚
â”‚  â””â”€ é£é™©ï¼šä¸­ç­‰ï¼ˆéœ€è¦æµ‹è¯•ï¼‰                                       â”‚
â”‚  â””â”€ æµ‹è¯•ï¼š./scripts/test-optimization.sh                        â”‚
â”‚                                                                   â”‚
â”‚ âœ… ç¬¬ 1 å‘¨æ€»ç»“ï¼šç³»ç»Ÿæ€§èƒ½æå‡ 80%ï¼Œç”¨æˆ·ä½“éªŒå¤§å¹…æ”¹å–„               â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 2 å‘¨ï¼šç¨³å®šæ€§å¢å¼ºï¼ˆæ”¶ç›Š 15%ï¼Œæ—¶é—´ 1 å‘¨ï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚ Mon-Tue (P1-4) [1h] æ±‡ç‡æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–                             â”‚
â”‚  â””â”€ ä¿®æ”¹ï¼šbackend/src/services/ExchangeRateService.ts            â”‚
â”‚  â””â”€        backend/src/services/HoldingService.ts                â”‚
â”‚  â””â”€ æ•ˆæœï¼šæ±‡ç‡æŸ¥è¯¢å‡å°‘ 90%                                      â”‚
â”‚  â””â”€ é£é™©ï¼šä½                                                     â”‚
â”‚                                                                   â”‚
â”‚ Wed (P2-4) [15min]  æ—¥å¿—çº§åˆ«ä¼˜åŒ–                                  â”‚
â”‚  â””â”€ ä¿®æ”¹ï¼šbackend/.env                                           â”‚
â”‚  â””â”€        backend/src/services/DatabaseService.ts              â”‚
â”‚  â””â”€ æ•ˆæœï¼šå‡å°‘ 30% I/O å¼€é”€                                     â”‚
â”‚  â””â”€ é£é™©ï¼šä½                                                     â”‚
â”‚                                                                   â”‚
â”‚ Thu-Fri (P2-1) [2h] Redis ç¼“å­˜é›†æˆ                               â”‚
â”‚  â””â”€ å‰ç½®ï¼šéƒ¨ç½² Redis æœåŠ¡                                        â”‚
â”‚  â””â”€ ä¿®æ”¹ï¼šbackend/src/services/CacheService.ts                   â”‚
â”‚  â””â”€        backend/src/services/PermissionService.ts             â”‚
â”‚  â””â”€ æ•ˆæœï¼šå¤šå®ä¾‹å…±äº«ç¼“å­˜ï¼Œç¼“å­˜å‘½ä¸­ç‡ 95%+                       â”‚
â”‚  â””â”€ é£é™©ï¼šä¸­ç­‰ï¼ˆéœ€è¦å¤„ç† Redis å¤±è´¥ï¼‰                            â”‚
â”‚                                                                   â”‚
â”‚ âœ… ç¬¬ 2 å‘¨æ€»ç»“ï¼šç³»ç»Ÿæ›´åŠ ç¨³å®šï¼Œæ”¯æŒå¤šå®ä¾‹éƒ¨ç½²                     â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 3 å‘¨ï¼šå¯æ‰©å±•æ€§æ”¹è¿›ï¼ˆæ”¶ç›Š 5%ï¼Œæ—¶é—´ 1 å‘¨ï¼‰                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚ Mon-Tue (P2-2) [1h] æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–                             â”‚
â”‚  â””â”€ ä¿®æ”¹ï¼šbackend/.env (DATABASE_URL)                            â”‚
â”‚  â””â”€ æ•ˆæœï¼šæ”¯æŒ 100+ å¹¶å‘ç”¨æˆ·                                    â”‚
â”‚  â””â”€ é£é™©ï¼šä½                                                     â”‚
â”‚                                                                   â”‚
â”‚ Wed-Thu (P2-3) [1h] API åˆ†å±‚åŠ è½½å®ç°                             â”‚
â”‚  â””â”€ ä¿®æ”¹ï¼šfrontend/src/components/charts/ChartDashboard.tsx      â”‚
â”‚  â””â”€ æ•ˆæœï¼šé¦–å±åŠ è½½ 3-5s â†’ 1-2s                                  â”‚
â”‚  â””â”€ é£é™©ï¼šä½                                                     â”‚
â”‚                                                                   â”‚
â”‚ Fri (æ€§èƒ½æµ‹è¯•) [1h]  æ€§èƒ½å›å½’æµ‹è¯•                                â”‚
â”‚  â””â”€ æµ‹è¯•ï¼š./scripts/performance-test.sh                          â”‚
â”‚  â””â”€ éªŒè¯ï¼šAPI å»¶è¿Ÿã€æ•°æ®åº“æŸ¥è¯¢æ•°ã€ç¼“å­˜å‘½ä¸­ç‡                    â”‚
â”‚  â””â”€ ç”Ÿæˆï¼šæ€§èƒ½æŠ¥å‘Š (performance-report.md)                      â”‚
â”‚                                                                   â”‚
â”‚ âœ… ç¬¬ 3 å‘¨æ€»ç»“ï¼šç³»ç»Ÿæ”¯æŒç”Ÿäº§çº§åˆ«çš„å¹¶å‘å’Œè´Ÿè½½                     â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç¬¬ 4 å‘¨ï¼šç›‘æ§å’Œæ–‡æ¡£                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚ Mon-Fri (æ€§èƒ½ç›‘æ§) [2h]                                          â”‚
â”‚  â””â”€ æ·»åŠ ï¼šPrometheus æŒ‡æ ‡æ”¶é›†                                    â”‚
â”‚  â””â”€ ä¿®æ”¹ï¼šbackend/src/middleware/performanceMonitor.ts           â”‚
â”‚  â””â”€        frontend/src/utils/performanceMonitoring.ts           â”‚
â”‚  â””â”€ æ•ˆæœï¼šå®æ—¶ç›‘æ§ç³»ç»Ÿæ€§èƒ½ï¼Œå¿«é€Ÿå‘ç°é—®é¢˜                        â”‚
â”‚                                                                   â”‚
â”‚ æ–‡æ¡£å’Œæ€»ç»“ [1h]                                                  â”‚
â”‚  â””â”€ æ›´æ–°ï¼šREADME.md (æ€§èƒ½æ•°æ®)                                   â”‚
â”‚  â””â”€ æ€»ç»“ï¼šä¼˜åŒ–æˆæœ (OPTIMIZATION_RESULTS.md)                    â”‚
â”‚  â””â”€ ç»´æŠ¤ï¼šä¼˜åŒ–æ¸…å• (MAINTENANCE_CHECKLIST.md)                   â”‚
â”‚                                                                   â”‚
â”‚ âœ… ç¬¬ 4 å‘¨æ€»ç»“ï¼šç³»ç»Ÿå®Œå…¨ä¼˜åŒ–ï¼Œå¯è¿›å…¥ç”Ÿäº§ç¯å¢ƒ                     â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ€§èƒ½æ”¹è¿›æ›²çº¿

```
å“åº”æ—¶é—´ (ms)
  2000 â”‚                          â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ P3 ä¼˜åŒ–
       â”‚                    â•­â”€â”€â”€â”€â”€â•¯           (é•¿æœŸ)
       â”‚              â•­â”€â”€â”€â”€â”€â•¯
  1500 â”‚         â•­â”€â”€â”€â”€â•¯       â””â”€ P2 ä¼˜åŒ–å®Œæˆ
       â”‚    â•­â”€â”€â”€â”€â•¯
       â”‚ â•­â”€â”€â•¯
  1000 â”‚â•­â•¯      â””â”€ P1 ä¼˜åŒ–ç¬¬ 1 å¤©
       â”‚â”‚         (æƒé™ç¼“å­˜ + è¶…æ—¶)
   500 â”‚â””â”€â”€â”€â”€â”€â”€â”€ P1 ä¼˜åŒ–å®Œæˆ
       â”‚          (N+1 æŸ¥è¯¢ä¿®å¤)
     0 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       â†“ æ—¶é—´ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’
      ç¬¬1å‘¨   ç¬¬2å‘¨   ç¬¬3å‘¨   ç¬¬4å‘¨
```

---

## ğŸ¯ æ¯ä¸ªä¼˜åŒ–çš„å…·ä½“æ­¥éª¤

### P1-1ï¼šæƒé™ç¼“å­˜ä¼˜åŒ–ï¼ˆ15 åˆ†é’Ÿï¼‰

**Step 1:** æ‰¾åˆ°æƒé™æŸ¥è¯¢çš„ç¼“å­˜è®¾ç½®
```bash
grep -n "hasPermission.*set" backend/src/services/PermissionService.ts
# è¾“å‡ºåº”è¯¥æ˜¾ç¤ºç¬¬ 264 è¡Œé™„è¿‘
```

**Step 2:** ä¿®æ”¹ç¼“å­˜æ—¶é—´
```diff
- this.cacheService.set(cacheKey, hasPermission, 60);
+ this.cacheService.set(cacheKey, hasPermission, 1800);
```

**Step 3:** æ·»åŠ æƒé™å˜æ›´æ—¶çš„ç¼“å­˜æ¸…é™¤
```typescript
async updateUserPermission(userId: string, ...) {
  // ... æ›´æ–°é€»è¾‘ ...
  
  // æ¸…é™¤è¯¥ç”¨æˆ·çš„æ‰€æœ‰æƒé™ç¼“å­˜
  const keys = this.cacheService.keys();
  const userKeys = keys.filter(k => k.startsWith(`${userId}:`));
  userKeys.forEach(k => this.cacheService.del(k));
}
```

**Step 4:** æµ‹è¯•
```bash
# å¯åŠ¨åç«¯
cd backend && npm run dev

# åœ¨å¦ä¸€ä¸ªç»ˆç«¯æµ‹è¯•
curl -H "Authorization: Bearer TOKEN" http://localhost:8000/api/portfolios

# æŸ¥çœ‹æ—¥å¿—ä¸­çš„è€—æ—¶ï¼ˆåº”è¯¥ä» 50ms é™åˆ° 1-5msï¼‰
tail -f /tmp/backend.log | grep -i duration
```

---

### P1-2ï¼šN+1 æŸ¥è¯¢ä¼˜åŒ–ï¼ˆ4 å°æ—¶ï¼‰

**Step 1:** åˆ†æå½“å‰æŸ¥è¯¢
```bash
# å¯ç”¨ Prisma æŸ¥è¯¢æ—¥å¿—
LOG_LEVEL=debug npm run dev

# è§‚å¯ŸæŠ•èµ„ç»„åˆåˆ—è¡¨åŠ è½½æ—¶æ‰§è¡Œäº†å¤šå°‘æ¡æŸ¥è¯¢
# åº”è¯¥çœ‹åˆ° 1 æ¡ SELECT * FROM portfolios
#       + N æ¡ SELECT * FROM positions WHERE portfolio_id = ...
```

**Step 2:** åˆ›å»ºæ–°çš„è”åˆæŸ¥è¯¢
```typescript
// backend/src/services/PortfolioService.ts

async getPortfoliosWithHoldingsSummary(userId: string) {
  // å•æ¡ SQL æŸ¥è¯¢ï¼ŒåŒ…å«æ‰€æœ‰å¿…è¦çš„æ•°æ®
  const query = `
    SELECT 
      p.*,
      COUNT(DISTINCT pos.id) as holding_count,
      SUM(pos.quantity * ap.close_price) as total_market_value
    FROM portfolios p
    LEFT JOIN positions pos ON p.id = pos.portfolio_id
    LEFT JOIN asset_prices ap ON pos.asset_id = ap.asset_id
    WHERE p.user_id = $1
    GROUP BY p.id
  `;
  
  return await databaseService.executeRawQuery(query, [userId]);
}
```

**Step 3:** æ›´æ–° API ä½¿ç”¨æ–°æ–¹æ³•
```typescript
// backend/src/controllers/PortfolioController.ts

async getPortfolios(req, res) {
  const portfolios = await this.portfolioService
    .getPortfoliosWithHoldingsSummary(userId);  // ä½¿ç”¨æ–°æ–¹æ³•
  
  res.json({ success: true, data: portfolios });
}
```

**Step 4:** æ·»åŠ æ•°æ®åº“ç´¢å¼•
```sql
CREATE INDEX idx_positions_portfolio_id 
ON positions(portfolio_id) WHERE is_active = true;

CREATE INDEX idx_asset_prices_asset_id_date 
ON asset_prices(asset_id, price_date DESC);
```

**Step 5:** æ€§èƒ½éªŒè¯
```bash
# å¯¹æ¯”ä¿®æ”¹å‰åçš„è€—æ—¶
# åº”è¯¥ä» 500-2000ms é™åˆ° 50-100ms

ab -n 100 -c 10 \
  -H "Authorization: Bearer TOKEN" \
  http://localhost:8000/api/portfolios
```

---

### P1-3ï¼šå‰ç«¯è¶…æ—¶æ§åˆ¶ï¼ˆ10 åˆ†é’Ÿï¼‰

**Step 1:** ä¿®æ”¹ api.ts ä¸­çš„ apiRequest å‡½æ•°
```typescript
export const apiRequest = async <T = any>(
  endpoint: string,
  options: RequestInit & { timeout?: number } = {}
): Promise<T> => {
  const timeout = options.timeout || 30000;
  const controller = new AbortController();
  const timeoutId = setTimeout(() => controller.abort(), timeout);

  try {
    const response = await fetch(url, {
      ...config,
      signal: controller.signal,  // å…³é”®ï¼šæ·»åŠ è¿™è¡Œ
    });
    clearTimeout(timeoutId);
    // ... å¤„ç†å“åº” ...
  } catch (error) {
    clearTimeout(timeoutId);
    if (error instanceof Error && error.name === 'AbortError') {
      throw new Error(`Request timeout after ${timeout}ms`);
    }
    throw error;
  }
};
```

**Step 2:** åœ¨ ChartDashboard ä¸­å¤„ç†è¶…æ—¶
```typescript
try {
  setLoading(true);
  const portfolios = await apiRequest('/portfolios', { timeout: 10000 });
  // ...
} catch (error) {
  if (error.message.includes('timeout')) {
    message.error('æ•°æ®åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
  } else {
    message.error('æ•°æ®åŠ è½½å¤±è´¥');
  }
  setChartData(getEmptyData());
} finally {
  setLoading(false);
}
```

**Step 3:** æµ‹è¯•è¶…æ—¶å¤„ç†
```javascript
// åœ¨æµè§ˆå™¨æ§åˆ¶å°ä¸­æµ‹è¯•
// Chrome DevTools â†’ Network â†’ Throttle é€‰æ‹© Slow 4G
// æˆ–ä½¿ç”¨ Puppeteer æ¨¡æ‹Ÿæ…¢é€Ÿç½‘ç»œ
```

---

### P1-4ï¼šæ±‡ç‡æ‰¹é‡æŸ¥è¯¢ï¼ˆ1 å°æ—¶ï¼‰

**Step 1:** ä¿®æ”¹ ExchangeRateService
```typescript
async getExchangeRatesBatch(
  pairs: Array<{ from: string; to: string }>
): Promise<Map<string, number>> {
  // å»é‡
  const uniquePairs = [...new Set(
    pairs.map(p => `${p.from}-${p.to}`)
  )];

  // æ‰¹é‡æŸ¥è¯¢ä¸åœ¨ç¼“å­˜ä¸­çš„æ±‡ç‡
  const missingPairs = uniquePairs.filter(pair => 
    !this.cacheService.has(`rate:${pair}`)
  );

  if (missingPairs.length > 0) {
    // ä¸€æ¬¡æ€§ä» API è·å–æ‰€æœ‰ç¼ºå¤±çš„æ±‡ç‡
    const rates = await this.fetchRatesFromAPI(missingPairs);
    
    // ç¼“å­˜ç»“æœ
    rates.forEach((rate, pair) => {
      this.cacheService.set(`rate:${pair}`, rate, 3600);
    });
  }

  // æ„å»ºè¿”å›æ•°æ®
  const result = new Map<string, number>();
  uniquePairs.forEach(pair => {
    result.set(pair, this.cacheService.get(`rate:${pair}`) || 1);
  });

  return result;
}
```

**Step 2:** æ›´æ–° HoldingService ä½¿ç”¨æ‰¹é‡æ–¹æ³•
```typescript
async getHoldingsByPortfolio(userId: string, portfolioId: string) {
  const positions = await this.fetchPositions(portfolioId);

  // æ”¶é›†æ‰€æœ‰æ±‡ç‡å¯¹
  const currencyPairs = [
    ...new Set(
      positions
        .filter(p => p.currency !== portfolioCurrency)
        .map(p => ({ from: p.currency, to: portfolioCurrency }))
    )
  ];

  // æ‰¹é‡è·å–æ±‡ç‡ï¼ˆå•æ¬¡è°ƒç”¨ï¼‰
  const ratesMap = await this.exchangeRateService.getExchangeRatesBatch(currencyPairs);

  // åº”ç”¨æ±‡ç‡
  return positions.map(pos => ({
    ...pos,
    exchangeRate: ratesMap.get(`${pos.currency}-${portfolioCurrency}`) || 1,
  }));
}
```

**Step 3:** éªŒè¯æ•ˆæœ
```bash
# æ±‡ç‡æŸ¥è¯¢åº”è¯¥ä» N æ¬¡ï¼ˆæ¯ä¸ªæŒä»“ä¸€æ¬¡ï¼‰å‡å°‘åˆ° 1 æ¬¡
LOG_LEVEL=debug npm run dev
# æŸ¥çœ‹æ—¥å¿—ä¸­çš„æ±‡ç‡ API è°ƒç”¨æ¬¡æ•°
```

---

## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡æ”¶é›†

### æ·»åŠ æ€§èƒ½ç›‘æ§ä¸­é—´ä»¶
```typescript
// backend/src/middleware/performanceMonitor.ts

export const performanceMonitor = (req, res, next) => {
  const startTime = process.hrtime.bigint();

  res.on('finish', () => {
    const duration = Number(process.hrtime.bigint() - startTime) / 1000000;
    
    // è®°å½•æ…¢æŸ¥è¯¢
    if (duration > 1000) {
      logger.warn(`Slow: ${req.method} ${req.path} - ${duration.toFixed(2)}ms`);
    }

    // å‘é€åˆ°ç›‘æ§ç³»ç»Ÿ
    metrics.recordRequestDuration(req.path, duration);
  });

  next();
};
```

### å‰ç«¯æ€§èƒ½è·Ÿè¸ª
```typescript
// frontend/src/utils/performanceMonitoring.ts

export const recordApiMetric = async (
  endpoint: string,
  fn: () => Promise<any>
) => {
  const start = performance.now();
  try {
    const result = await fn();
    const duration = performance.now() - start;
    
    console.log(`API: ${endpoint} - ${duration.toFixed(2)}ms`);
    
    if (duration > 2000) {
      console.warn(`âš ï¸ Slow API: ${endpoint}`);
    }
    
    return result;
  } catch (error) {
    const duration = performance.now() - start;
    console.error(`âŒ Error: ${endpoint} after ${duration.toFixed(2)}ms`, error);
    throw error;
  }
};
```

---

## âœ… ä¼˜åŒ–éªŒè¯æ¸…å•

### ç¬¬ 1 å‘¨éªŒæ”¶æ ‡å‡†
- [ ] æƒé™æŸ¥è¯¢å»¶è¿Ÿ < 5msï¼ˆä»ç¼“å­˜ï¼‰
- [ ] æŠ•èµ„ç»„åˆåˆ—è¡¨æŸ¥è¯¢ < 100ms
- [ ] å‰ç«¯è¯·æ±‚æœ‰ 30 ç§’è¶…æ—¶
- [ ] æ•°æ®åº“ç´¢å¼•å·²åˆ›å»º
- [ ] N+1 æŸ¥è¯¢å·²ä¿®å¤ï¼ˆæ€»æŸ¥è¯¢æ•° < 5ï¼‰
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡ç‡ > 95%

### ç¬¬ 2 å‘¨éªŒæ”¶æ ‡å‡†
- [ ] Redis ç¼“å­˜è¿è¡Œæ­£å¸¸
- [ ] ç¼“å­˜å‘½ä¸­ç‡ > 80%
- [ ] æ±‡ç‡æŸ¥è¯¢åªæ‰§è¡Œ 1 æ¬¡
- [ ] æ—¥å¿— I/O å‡å°‘ 30%
- [ ] é›†æˆæµ‹è¯•é€šè¿‡ç‡ > 95%

### ç¬¬ 3 å‘¨éªŒæ”¶æ ‡å‡†
- [ ] å•å®ä¾‹æ”¯æŒ 100+ å¹¶å‘ç”¨æˆ·
- [ ] API é¦–å±åŠ è½½ < 2s
- [ ] æ•°æ®åº“è¿æ¥æ± æœªè€—å°½
- [ ] æ€§èƒ½æµ‹è¯•é€šè¿‡æ‰€æœ‰æŒ‡æ ‡

### ç¬¬ 4 å‘¨éªŒæ”¶æ ‡å‡†
- [ ] æ€§èƒ½ç›‘æ§ç³»ç»Ÿè¿è¡Œ
- [ ] æ–‡æ¡£å®Œæ•´æ›´æ–°
- [ ] ä¼˜åŒ–æˆæœæ€»ç»“å®Œæˆ
- [ ] ç»´æŠ¤æµç¨‹æ–‡æ¡£åŒ–

---

## ğŸš¨ é£é™©ç®¡ç†

### å¯èƒ½çš„é—®é¢˜åŠåº”å¯¹

**é—®é¢˜ 1ï¼šä¿®æ”¹åå‡ºç°æ•°æ®ä¸ä¸€è‡´**
```
åŸå› ï¼šç¼“å­˜è¿‡æœŸæ—¶é—´ä¸åŒæ­¥
è§£å†³ï¼š
  - å®ç°ç¼“å­˜é¢„çƒ­æœºåˆ¶
  - æ•°æ®æ›´æ–°æ—¶ä¸»åŠ¨æ¸…é™¤ç¼“å­˜
  - å®šæœŸæ ¡éªŒç¼“å­˜å’Œæ•°æ®åº“ä¸€è‡´æ€§
```

**é—®é¢˜ 2ï¼šRedis æœåŠ¡æ•…éšœ**
```
åŸå› ï¼šRedis è¿æ¥å¤±è´¥
è§£å†³ï¼š
  - é…ç½®è‡ªåŠ¨é‡è¿
  - é™çº§åˆ°æœ¬åœ°ç¼“å­˜
  - ç›‘æ§ Redis å¥åº·çŠ¶æ€
```

**é—®é¢˜ 3ï¼šæ•°æ®åº“è¿æ¥æ•°å¢åŠ **
```
åŸå› ï¼šä¼˜åŒ–å¢åŠ äº†æ•°æ®åº“è®¿é—®
è§£å†³ï¼š
  - è°ƒæ•´è¿æ¥æ± å¤§å°
  - å¯ç”¨è¿æ¥å¤ç”¨
  - ç›‘æ§è¿æ¥æ•°
```

**é—®é¢˜ 4ï¼šæŸäº›ç”¨æˆ·æŠ¥å‘Šå˜æ…¢**
```
åŸå› ï¼šç”¨æˆ·çš„æ•°æ®é‡ç‰¹åˆ«å¤§
è§£å†³ï¼š
  - å®ç°åˆ†é¡µåŠ è½½
  - æ·»åŠ æ•°æ®é‡é™åˆ¶
  - é’ˆå¯¹å¤§æ•°æ®é›†ä¼˜åŒ–æŸ¥è¯¢
```

---

## ğŸ“ æ”¯æŒèµ„æº

- **è¯¦ç»†ä¼˜åŒ–æ–¹æ¡ˆï¼š** `/OPTIMIZATION_RECOMMENDATIONS.md`
- **å¿«é€Ÿå‚è€ƒæŒ‡å—ï¼š** `/QUICK_OPTIMIZATION_GUIDE.md`
- **æ€§èƒ½æµ‹è¯•è„šæœ¬ï¼š** `/scripts/performance-test.sh`
- **ç›‘æ§ä»ªè¡¨æ¿ï¼š** (å°†åœ¨ P4 å®æ–½)

---

## ğŸ“ å­¦ä¹ èµ„æº

- PostgreSQL ç´¢å¼•ä¼˜åŒ–ï¼šhttps://www.postgresql.org/docs/current/indexes.html
- Prisma æ€§èƒ½ä¼˜åŒ–ï¼šhttps://www.prisma.io/docs/concepts/components/prisma-client/performance-optimization
- Redis ç¼“å­˜ç­–ç•¥ï¼šhttps://redis.io/docs/manual/client-side-caching/
- Node.js æ€§èƒ½ä¼˜åŒ–ï¼šhttps://nodejs.org/en/docs/guides/simple-profiling/

---

## ğŸ“ æäº¤è§„èŒƒ

æ¯ä¸ªä¼˜åŒ–å®Œæˆåï¼Œæäº¤ Git commitï¼š

```bash
git commit -m "opt: P1-1 æƒé™ç¼“å­˜ä¼˜åŒ– (60s â†’ 1800s)

- å¢åŠ æƒé™ç¼“å­˜æ—¶é—´åˆ° 30 åˆ†é’Ÿ
- æ·»åŠ æƒé™å˜æ›´æ—¶çš„ç¼“å­˜æ¸…é™¤
- æ€§èƒ½æå‡ï¼š50ms â†’ 5msï¼ˆ40 å€ï¼‰
- æµ‹è¯•é€šè¿‡ç‡ï¼š100%
- æ•°æ®åº“æŸ¥è¯¢å‡å°‘ï¼š90%

Closes #ISSUE_NUMBER"
```

---

**å‡†å¤‡å¥½å¼€å§‹ä¼˜åŒ–äº†å—ï¼Ÿä» P1-1 å¼€å§‹ï¼** ğŸš€
