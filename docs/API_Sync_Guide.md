# API 自动同步功能使用指南

## 📋 功能概述

API 自动同步功能允许您从外部数据源自动获取和更新资产价格数据，支持多种数据源和灵活的调度策略。

## 🎯 核心功能

### 1. 数据源管理
- 支持多个数据源提供商（Yahoo Finance、东方财富、Tushare等）
- 配置 API 密钥和访问参数
- 监控数据源状态和同步历史

### 2. 同步任务配置
- **手动执行**：按需手动触发同步
- **Cron 调度**：使用 Cron 表达式定时执行（如每天16:00）
- **间隔调度**：按固定时间间隔执行（如每30分钟）

### 3. 同步策略
- 指定同步的资产类型或市场
- 设置回溯天数（获取历史数据）
- 选择是否覆盖已有数据

### 4. 执行监控
- 实时查看任务执行状态
- 详细的同步日志和统计
- 错误追踪和诊断

## 🚀 快速开始

### 步骤 1: 查看可用数据源

系统预置了以下数据源：

| 数据源 | 提供商 | 支持市场 | 需要API密钥 |
|--------|--------|----------|-------------|
| Yahoo Finance | yahoo_finance | 全球市场 | 否 |
| 东方财富 | eastmoney | 中国A股 | 否 |
| Tushare | tushare | 中国市场 | 是 |

### 步骤 2: 创建同步任务

1. 进入 **价格管理中心** → **API自动同步** → **同步任务**
2. 点击 **创建同步任务** 按钮
3. 填写任务信息：
   - **任务名称**：例如 "每日A股价格同步"
   - **任务描述**：任务的详细说明
   - **数据源**：选择要使用的数据源
   - **调度类型**：选择执行方式
   - **回溯天数**：设置获取多少天的历史数据
   - **覆盖已有数据**：是否更新已存在的价格记录

### 步骤 3: 配置调度策略

#### 手动执行
适用于临时性的数据同步需求。

#### Cron 表达式
使用标准 Cron 表达式定时执行：

```
# 格式: 秒 分 时 日 月 星期
0 0 16 * * ?    # 每天16:00执行
0 30 9 * * ?    # 每天9:30执行
0 0 0 * * 1     # 每周一0:00执行
0 0 12 1 * ?    # 每月1日12:00执行
```

#### 定时间隔
按固定时间间隔执行：
- 30 分钟
- 60 分钟（1小时）
- 240 分钟（4小时）

### 步骤 4: 执行和监控

1. **手动执行**：点击任务列表中的 ▶️ 按钮立即执行
2. **查看状态**：在任务列表中查看最后运行时间和状态
3. **查看日志**：切换到 **同步日志** 标签页查看详细执行记录

## 📊 同步日志说明

### 日志字段

| 字段 | 说明 |
|------|------|
| 任务名称 | 执行的同步任务 |
| 数据源 | 使用的数据源 |
| 开始时间 | 任务开始执行的时间 |
| 完成时间 | 任务完成的时间 |
| 状态 | 成功/失败/运行中/部分成功 |
| 资产数 | 同步的资产数量 |
| 记录数 | 总价格记录数 |
| 成功 | 成功保存的记录数 |
| 失败 | 失败的记录数 |
| 耗时 | 执行耗时（秒） |

### 状态说明

- **成功** ✅：所有数据同步成功
- **失败** ❌：同步过程出现错误
- **运行中** 🔄：任务正在执行
- **部分成功** ⚠️：部分数据同步成功，部分失败

## ⚙️ 高级配置

### 数据源配置

如需添加自定义数据源或配置 API 密钥，请联系系统管理员。

### 资产筛选

创建任务时可以指定：
- **资产类型**：只同步特定类型的资产（如股票、基金）
- **市场**：只同步特定市场的资产（如上交所、深交所）
- **资产列表**：指定具体的资产ID列表

### 性能优化

- **批量同步**：系统会自动批量处理数据，提高效率
- **速率限制**：遵守数据源的API调用限制
- **错误重试**：失败的记录会被记录，可手动重试

## 🔧 故障排除

### 常见问题

#### 1. 同步任务失败
**可能原因**：
- 数据源API不可用
- 网络连接问题
- API密钥无效或过期
- 超过速率限制

**解决方法**：
- 检查数据源状态
- 验证网络连接
- 更新API密钥
- 调整同步频率

#### 2. 部分数据同步失败
**可能原因**：
- 某些资产代码在数据源中不存在
- 数据格式不符合要求
- 价格数据验证失败

**解决方法**：
- 查看同步日志中的错误详情
- 检查资产代码是否正确
- 手动补充失败的数据

#### 3. 定时任务未执行
**可能原因**：
- 任务未启用
- Cron表达式错误
- 服务器时间不正确

**解决方法**：
- 确认任务状态为"启用"
- 验证Cron表达式格式
- 检查服务器时区设置

## 📝 最佳实践

### 1. 合理设置同步频率
- **日K数据**：每天收盘后同步一次即可
- **实时数据**：根据需要设置较短的间隔
- **历史数据**：使用手动执行，避免重复同步

### 2. 数据覆盖策略
- **首次同步**：建议启用"覆盖已有数据"
- **日常同步**：可以关闭覆盖，只添加新数据
- **数据修正**：需要更新错误数据时启用覆盖

### 3. 监控和维护
- 定期检查同步日志
- 关注失败记录并及时处理
- 根据实际情况调整同步策略

### 4. 资源管理
- 避免同时运行多个大规模同步任务
- 合理设置回溯天数，避免不必要的数据获取
- 定期清理过期的同步日志

## 🔐 安全说明

- API密钥会加密存储在数据库中
- 只有具有管理员权限的用户可以配置数据源
- 所有同步操作都会记录审计日志

## 📞 技术支持

如遇到问题或需要帮助，请：
1. 查看同步日志中的错误信息
2. 参考本文档的故障排除部分
3. 联系系统管理员

---

**最后更新**: 2025-10-26  
**版本**: v1.0
