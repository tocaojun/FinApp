# 架构决策框架：市场维度 vs 国家维度

## 核心问题

**问题**：应该如何在系统中表示"资产的地理位置"？

**你的提议**：
- 以"国家"作为主维度
- 弱化"交易市场"作为可选细节
- 为"全球资产"提供明确支持

**本文**：帮助做出正确的架构决策

---

## 决策矩阵

### 评估维度

为了评估改进是否值得，考虑这些因素：

#### 1. 业务需求强度

```
问题：你的用户真的需要支持跨国上市企业吗？

数据来源：
  ☐ 调查：用户主要购买什么股票？
  ☐ 数据分析：现有资产中有多少是跨国上市的？
  ☐ 市场：你的目标市场是否需要这个功能？

得分标准：
  1 = 用户不需要（90%+ 单市场资产）
  2 = 用户偶尔需要（10-30% 跨国资产）
  3 = 用户经常需要（30-50% 跨国资产）
  4 = 用户必须需要（50%+ 跨国资产）
```

#### 2. 实现复杂度

```
问题：改进的实现成本有多高？

评估项：
  • 数据库迁移        ☐ 简单  ☐ 中等  ☐ 复杂
  • 代码修改          ☐ 简单  ☐ 中等  ☐ 复杂
  • 前端调整          ☐ 简单  ☐ 中等  ☐ 复杂
  • 数据清洗          ☐ 简单  ☐ 中等  ☐ 复杂

总体评分：
  1-2 = 值得立即做（低成本）
  3-4 = 值得考虑（中等成本）
  5-6 = 需要谨慎（高成本）
```

#### 3. 用户体验改进

```
问题：用户体验会改进多少？

现在的体验问题：
  ☐ 用户困惑（返回多个同一企业的记录）
  ☐ 选择困难（不清楚应该选哪个交易所）
  ☐ 数据重复（企业信息重复存储）

改进后的体验：
  ☐ 更清晰（一个企业一条记录）
  ☐ 更直观（国家为主要选择）
  ☐ 更灵活（支持多交易所）

收益评分：
  1 = 没有改进
  2 = 小改进（用户不会注意到）
  3 = 明显改进（用户会反馈）
  4 = 重大改进（用户期待的功能）
```

#### 4. 长期可维护性

```
问题：改进是否提高代码的可维护性？

评估项：
  • 代码复杂度      ☐ 更简单  ☐ 不变  ☐ 更复杂
  • 数据一致性      ☐ 更强    ☐ 不变  ☐ 更弱
  • 扩展性          ☐ 更好    ☐ 不变  ☐ 更差
  • 团队理解难度    ☐ 更容易  ☐ 不变  ☐ 更难

整体评分：
  1 = 可维护性下降（不应该改）
  2 = 可维护性不变
  3 = 可维护性改进（应该改）
```

---

## 决策树

```
开始
  ↓
1. 你的用户需要支持跨国上市企业吗？
  ├─ 否（90%+ 单市场资产）
  │   ↓
  │   → 目前不需要改（当前模型足够）
  │
  └─ 是（20%+ 跨国资产）
      ↓
2. 这个需求的紧迫程度如何？
  ├─ 低（可以等等）
  │   ↓
  │   → 延迟改进（收集更多需求）
  │   → 转到：5 年计划
  │
  └─ 高（用户现在就需要）
      ↓
3. 你有资源进行大规模重构吗？
  ├─ 否
  │   ↓
  │   → 寻找折中方案
  │   → 转到：快速修复方案
  │
  └─ 是
      ↓
4. 你愿意投入 2-4 周进行改进吗？
  ├─ 否
  │   ↓
  │   → 实施最小化改进
  │   → 转到：最小化改进
  │
  └─ 是
      ↓
5. 是否有其他架构问题需要解决？
  ├─ 是（多个问题）
  │   ↓
  │   → 一起解决所有问题
  │   → 转到：完整重构
  │
  └─ 否（只有这个问题）
      ↓
      → 实施改进模型
      → 转到：改进实施路线

```

---

## 方案对比

### 选项 A：保持现状

```
当前实现
├─ 优点
│  ├─ ✅ 已经验证过
│  ├─ ✅ 没有迁移成本
│  ├─ ✅ 代码清晰
│  └─ ✅ 团队熟悉
│
├─ 缺点
│  ├─ ❌ 跨国上市企业需要多条记录
│  ├─ ❌ 用户可能困惑
│  ├─ ❌ 信息冗余
│  └─ ❌ 查询复杂
│
├─ 成本：0
├─ 收益：0
└─ 建议场景：
   当用户主要是单市场投资者
   当资源有限时
```

### 选项 B：最小化改进

```
添加 listed_markets 字段，但保持主要结构不变
├─ 变更
│  ├─ 添加 assets.listed_markets (JSON数组)
│  ├─ 添加 assets.listed_symbols (JSONB)
│  └─ 保留 market_id 作为主市场
│
├─ 优点
│  ├─ ✅ 可以表示多交易所信息
│  ├─ ✅ 改动最小
│  ├─ ✅ 向后兼容
│  └─ ✅ 迁移简单
│
├─ 缺点
│  ├─ ❌ 查询仍然复杂
│  ├─ ❌ 逻辑混乱（两个维度并存）
│  └─ ❌ 不是完整的解决方案
│
├─ 成本：1 周
├─ 收益：40%（部分支持）
└─ 建议场景：
   想快速解决问题
   有少量跨国资产
```

### 选项 C：国家优先模型

```
完全重新设计，国家作为主维度
├─ 变更
│  ├─ 移除 market_id 作为必填
│  ├─ 将 country_id 作为主维度
│  ├─ 添加 listed_markets 作为主信息
│  ├─ 添加 location_type 标记
│  └─ 更新 price_data_sources 配置
│
├─ 优点
│  ├─ ✅ 清晰的主维度
│  ├─ ✅ 完美支持跨国资产
│  ├─ ✅ 查询简单（WHERE country_id = ?)
│  ├─ ✅ 符合投资者思维
│  ├─ ✅ 全球资产支持清晰
│  └─ ✅ 长期可维护
│
├─ 缺点
│  ├─ ❌ 大规模迁移
│  ├─ ❌ 代码重写
│  ├─ ❌ 前端大改
│  ├─ ❌ 需要 2-4 周
│  └─ ❌ 短期有风险
│
├─ 成本：2-4 周 + 风险
├─ 收益：100%（完整解决）
└─ 建议场景：
   即将进行大规模重构
   有充足资源
   长期价值很高
```

### 选项 D：混合模型

```
分层设计：国家为主，市场为辅
├─ 变更
│  ├─ Country 为主维度
│  ├─ Market 为可选的细化
│  ├─ 数据源配置支持两层
│  └─ 前端级联选择器
│
├─ 优点
│  ├─ ✅ 兼顾简洁和准确
│  ├─ ✅ 支持多种场景
│  ├─ ✅ 不同阶段改进
│  └─ ✅ 降低风险
│
├─ 缺点
│  ├─ ❌ 中等复杂度
│  ├─ ❌ 学习曲线
│  └─ ❌ 维护需要谨慎
│
├─ 成本：1-2 周
├─ 收益：80%（大部分支持）
└─ 建议场景：
   资源有限但需求明确
   分阶段改进的计划
```

---

## 快速评估表

**问题**：你应该选择哪个选项？

回答以下问题，得到建议：

```
1. 你的平台主要服务哪些投资者？
   ☐ A. 仅中国投资者（本地股票为主）      → +0 分
   ☐ B. 国内和国际投资者混合              → +1 分
   ☐ C. 全球投资者（多国资产）            → +2 分

2. 你的数据中，跨国上市的企业占比？
   ☐ A. < 5%                              → +0 分
   ☐ B. 5-20%                             → +1 分
   ☐ C. > 20%                             → +2 分

3. 用户从你收到的反馈中，关于这个的投诉？
   ☐ A. 很少或没有                        → +0 分
   ☐ B. 偶尔提到                          → +1 分
   ☐ C. 经常投诉                          → +2 分

4. 你的团队规模和能力？
   ☐ A. 小团队（1-2人），能力有限         → +0 分
   ☐ B. 中等团队（3-5人），能力不错       → +1 分
   ☐ C. 大团队（5+人），能力强            → +2 分

5. 你有多少时间用于改进？
   ☐ A. 有限（本周内要完成）              → +0 分
   ☐ B. 中等（1-2周）                    → +1 分
   ☐ C. 充足（2-4周或更多）              → +2 分

TOTAL: _____ 分
```

### 评分结果：

```
0-3 分   → 选项 A：保持现状
          理由：需求不急，资源有限
          建议：监控用户反馈，定期重新评估

4-6 分   → 选项 B：最小化改进
          理由：需求明确但资源有限
          建议：快速添加 listed_markets 支持
          时间线：本周完成

7-9 分   → 选项 D：混合模型
          理由：需求中等，资源够用
          建议：分阶段实施国家优先模型
          时间线：1-2 周

10+ 分  → 选项 C：国家优先模型
          理由：需求明确，资源充足
          建议：完整重设计和重构
          时间线：2-4 周 + 验证
```

---

## 实施路线

### 短期（当前 - 2 周）

```
选项 B 实施：最小化改进

步骤：
1. 添加两个字段到 assets
   ├─ listed_markets: VARCHAR[]
   └─ listed_symbols: JSONB

2. 迁移现有数据
   ├─ 单市场资产：listed_markets = [primary_market]
   └─ 多市场资产：填充所有交易所

3. 更新查询逻辑
   ├─ 保持向后兼容
   └─ 支持新的查询方式

4. 简单的前端改动
   └─ 显示所有可用交易所

工作量：3-4 天
风险：低
收益：立即解决问题的 40%
```

### 中期（1-3 个月）

```
如果反馈良好，继续改进：

步骤：
1. 设计完整的国家优先模型
2. 制作原型验证
3. 收集更多需求反馈
4. 制定完整迁移计划

工作量：1-2 周设计 + 反馈
风险：低（仅设计）
收益：为长期改进做准备
```

### 长期（3-6 个月）

```
如果决定完全改进：

步骤：
1. 分阶段实施选项 C
2. 保持向后兼容
3. 逐步迁移用户
4. 完全切换到新模型

工作量：2-4 周开发 + 1-2 周测试
风险：中等（大规模改动）
收益：完整的解决方案
```

---

## 决策建议

### 我的推荐

基于常见场景，我的建议是：

#### 👉 立即做（现在）
- ✅ 实施选项 B：最小化改进
- ✅ 添加 listed_markets 字段
- ✅ 时间投入：3-4 天
- ✅ 收益：解决 40% 的问题，零风险

#### 🔄 计划中（1-3 个月）
- ✅ 收集用户需求和数据分析
- ✅ 评估国家优先模型是否必要
- ✅ 制作原型验证方案

#### 🚀 未来可能（3-6 个月）
- ✅ 如果数据支持，考虑选项 C
- ✅ 做为下一个重大版本的一部分
- ✅ 而非紧急修复

### 为什么这个顺序？

```
阶段1（快速）：获得 40% 的收益，零风险
  ↓
阶段2（评估）：验证是否需要进一步改进
  ↓
阶段3（规划）：如果需要，制定完整计划
  ↓
阶段4（实施）：一次性完全改进
```

---

## 关键问题列表

在做出最终决定前，问自己这些问题：

### 业务相关
```
☐ 你的用户主要投资哪些资产？单国还是多国？
☐ 有多少用户抱怨过选择交易所的问题？
☐ 跨国上市的企业在你的平台占比多少？
☐ 你计划支持多少个国家的市场？
☐ 全球加密货币是否是重要功能？
```

### 技术相关
```
☐ 你的数据库目前有多少资产数据？
☐ 迁移会有多大风险？
☐ 有测试环境可以验证吗？
☐ 是否需要 0-downtime 迁移？
☐ 现有 API 用户会受影响吗？
```

### 资源相关
```
☐ 你有多少 developer 可以参与？
☐ 需要多少时间进行改进？
☐ QA 资源够吗？
☐ 文档更新需要多久？
☐ 用户沟通和教育成本多少？
```

---

## 总结

| 方面 | 保持现状 | 最小化改进 | 混合模型 | 完全改进 |
|------|---------|----------|---------|---------|
| **立即价值** | 0% | 40% | 70% | 100% |
| **实施成本** | 0 天 | 3-4 天 | 1-2 周 | 2-4 周 |
| **风险** | 无 | 极低 | 低 | 中等 |
| **长期价值** | ❌ | ⚠️ | ✅ | ✅✅ |
| **推荐场景** | 需求不明 | 需求明确 | 资源充足 | 完整重构 |

**我的建议**：
1. 现在：实施选项 B（3-4 天，无风险）
2. 观察用户反馈（1 个月）
3. 根据反馈决定是否做选项 C
4. 如果做，作为下一版本的重大改进

这样可以既解决眼前的问题，又为长期改进做准备。
