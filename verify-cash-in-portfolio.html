<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éªŒè¯å¤šå¸ç§ç°é‡‘åœ¨æŠ•èµ„ç»„åˆä¸­çš„æ˜¾ç¤º</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f5f5f5; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .section { 
            margin-bottom: 30px; 
            padding: 15px; 
            border: 1px solid #e0e0e0; 
            border-radius: 5px; 
        }
        .success { background-color: #f6ffed; border-color: #b7eb8f; }
        .error { background-color: #fff2f0; border-color: #ffccc7; }
        .info { background-color: #f0f9ff; border-color: #bae7ff; }
        h1, h2 { color: #333; }
        .result { 
            font-family: monospace; 
            background: #f8f8f8; 
            padding: 10px; 
            border-radius: 4px; 
            white-space: pre-wrap; 
        }
        button { 
            background: #1890ff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-right: 10px; 
        }
        button:hover { background: #40a9ff; }
        .status { font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¦ å¤šå¸ç§ç°é‡‘åœ¨æŠ•èµ„ç»„åˆç»Ÿè®¡ä¸­çš„éªŒè¯</h1>
        
        <div class="section info">
            <h2>ğŸ“‹ éªŒè¯ç›®æ ‡</h2>
            <p>ç¡®è®¤å¤šå¸ç§ç°é‡‘ä½™é¢æŒ‰æ±‡ç‡æŠ˜ç®—åæ­£ç¡®ç»Ÿè®¡åˆ°æŠ•èµ„ç»„åˆæ€»ä»·å€¼ä¸­</p>
            <ul>
                <li>âœ… åç«¯å·²ä¿®æ”¹æŠ•èµ„ç»„åˆç»Ÿè®¡é€»è¾‘ï¼ŒåŒ…å«ç°é‡‘ä½™é¢</li>
                <li>âœ… æ·»åŠ äº†æ±‡ç‡è½¬æ¢ï¼Œå°†ä¸åŒå¸ç§ç°é‡‘è½¬æ¢ä¸ºåŸºç¡€è´§å¸</li>
                <li>âœ… å‰ç«¯ç±»å‹å®šä¹‰å·²æ›´æ–°ï¼ŒåŒ…å« totalCashValue å­—æ®µ</li>
                <li>ğŸ”„ æ­£åœ¨éªŒè¯å‰ç«¯æ˜¾ç¤ºæ˜¯å¦æ­£å¸¸</li>
            </ul>
        </div>

        <div class="section">
            <h2>ğŸ§ª API æµ‹è¯•</h2>
            <button onclick="testLogin()">1. ç™»å½•è·å–Token</button>
            <button onclick="testPortfolioSummary()">2. æµ‹è¯•æŠ•èµ„ç»„åˆæ±‡æ€»</button>
            <button onclick="testCashBalances()">3. æŸ¥çœ‹ç°é‡‘ä½™é¢</button>
            <div id="apiResults" class="result"></div>
        </div>

        <div class="section">
            <h2>ğŸ“Š æ•°æ®éªŒè¯</h2>
            <div id="dataValidation" class="result">
ç­‰å¾…APIæµ‹è¯•ç»“æœ...
            </div>
        </div>

        <div class="section success">
            <h2>âœ… å·²å®Œæˆçš„åŠŸèƒ½</h2>
            <ul>
                <li><strong>åç«¯ä¿®æ”¹</strong>ï¼šæŠ•èµ„ç»„åˆç»Ÿè®¡æœåŠ¡å·²åŒ…å«å¤šå¸ç§ç°é‡‘ä½™é¢è®¡ç®—</li>
                <li><strong>æ±‡ç‡è½¬æ¢</strong>ï¼šä¸åŒå¸ç§ç°é‡‘æŒ‰å®æ—¶æ±‡ç‡è½¬æ¢ä¸ºåŸºç¡€è´§å¸</li>
                <li><strong>æ•°æ®åº“æŸ¥è¯¢</strong>ï¼šä¼˜åŒ–æŸ¥è¯¢é€»è¾‘ï¼ŒæŒ‰å¸ç§åˆ†ç»„ç»Ÿè®¡ç°é‡‘ä½™é¢</li>
                <li><strong>ç±»å‹å®šä¹‰</strong>ï¼šå‰åç«¯ç±»å‹å®šä¹‰å·²åŒæ­¥æ›´æ–°</li>
                <li><strong>æµ‹è¯•æ•°æ®</strong>ï¼šå·²æ·»åŠ å¤šå¸ç§ç°é‡‘æµ‹è¯•æ•°æ®</li>
            </ul>
        </div>
    </div>

    <script>
        let authToken = '';
        const API_BASE = 'http://localhost:8000/api';
        
        async function testLogin() {
            const resultDiv = document.getElementById('apiResults');
            resultDiv.innerHTML = 'æ­£åœ¨ç™»å½•...';
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: 'testapi@finapp.com',
                        password: 'testapi123'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    authToken = data.data.token;
                    resultDiv.innerHTML = `âœ… ç™»å½•æˆåŠŸ\nToken: ${authToken.substring(0, 50)}...`;
                } else {
                    resultDiv.innerHTML = `âŒ ç™»å½•å¤±è´¥: ${data.message}`;
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }
        
        async function testPortfolioSummary() {
            if (!authToken) {
                alert('è¯·å…ˆç™»å½•è·å–Token');
                return;
            }
            
            const resultDiv = document.getElementById('apiResults');
            resultDiv.innerHTML = 'æ­£åœ¨è·å–æŠ•èµ„ç»„åˆæ±‡æ€»...';
            
            try {
                // ä½¿ç”¨æµ‹è¯•æŠ•èµ„ç»„åˆID
                const portfolioId = '362ea194-1d0f-4586-9dd4-04c4794ffcd4';
                const response = await fetch(`${API_BASE}/portfolios/${portfolioId}/summary`, {
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    const summary = data.data;
                    resultDiv.innerHTML = `âœ… æŠ•èµ„ç»„åˆæ±‡æ€»è·å–æˆåŠŸ:
æŠ•èµ„ç»„åˆåç§°: ${summary.portfolio.name}
åŸºç¡€è´§å¸: ${summary.portfolio.baseCurrency}
æ€»ä»·å€¼: Â¥${summary.totalValue?.toFixed(2) || 0}
ç°é‡‘ä»·å€¼: Â¥${summary.totalCashValue?.toFixed(2) || 0}
æ€»æˆæœ¬: Â¥${summary.totalCost?.toFixed(2) || 0}
æ€»æ”¶ç›Š: Â¥${summary.totalReturn?.toFixed(2) || 0}
èµ„äº§æ•°é‡: ${summary.uniqueAssets}
äº¤æ˜“è´¦æˆ·: ${summary.totalAccounts}`;
                    
                    validateData(summary);
                } else {
                    resultDiv.innerHTML = `âŒ è·å–å¤±è´¥: ${data.message || data.error?.message}`;
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }
        
        async function testCashBalances() {
            if (!authToken) {
                alert('è¯·å…ˆç™»å½•è·å–Token');
                return;
            }
            
            const resultDiv = document.getElementById('apiResults');
            resultDiv.innerHTML = 'æ­£åœ¨è·å–ç°é‡‘ä½™é¢...';
            
            try {
                const response = await fetch(`${API_BASE}/multi-currency-cash/balances`, {
                    headers: { 
                        'Authorization': `Bearer ${authToken}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                if (data.success) {
                    let cashInfo = 'âœ… å¤šå¸ç§ç°é‡‘ä½™é¢:\n';
                    data.data.forEach(account => {
                        cashInfo += `\nè´¦æˆ·: ${account.accountName}`;
                        account.balances.forEach(balance => {
                            cashInfo += `\n  ${balance.currency}: ${balance.cashBalance}`;
                        });
                    });
                    resultDiv.innerHTML = cashInfo;
                } else {
                    resultDiv.innerHTML = `âŒ è·å–ç°é‡‘ä½™é¢å¤±è´¥: ${data.message}`;
                }
            } catch (error) {
                resultDiv.innerHTML = `âŒ è¯·æ±‚å¤±è´¥: ${error.message}`;
            }
        }
        
        function validateData(summary) {
            const validationDiv = document.getElementById('dataValidation');
            let validation = 'ğŸ“Š æ•°æ®éªŒè¯ç»“æœ:\n\n';
            
            // æ£€æŸ¥ç°é‡‘ä»·å€¼æ˜¯å¦åŒ…å«åœ¨æ€»ä»·å€¼ä¸­
            const hasCashValue = summary.totalCashValue && summary.totalCashValue > 0;
            const hasPositiveTotal = summary.totalValue && summary.totalValue > 0;
            
            validation += `1. ç°é‡‘ä»·å€¼æ£€æŸ¥: ${hasCashValue ? 'âœ… åŒ…å«ç°é‡‘ä»·å€¼' : 'âŒ æ— ç°é‡‘ä»·å€¼'}\n`;
            validation += `2. æ€»ä»·å€¼æ£€æŸ¥: ${hasPositiveTotal ? 'âœ… æœ‰æ­£æ•°æ€»ä»·å€¼' : 'âŒ æ€»ä»·å€¼ä¸ºé›¶æˆ–è´Ÿæ•°'}\n`;
            validation += `3. èµ„äº§ç»Ÿè®¡æ£€æŸ¥: ${summary.uniqueAssets > 0 ? 'âœ… åŒ…å«èµ„äº§' : 'âŒ æ— èµ„äº§ç»Ÿè®¡'}\n`;
            
            // è®¡ç®—ç°é‡‘å æ¯”
            if (hasCashValue && hasPositiveTotal) {
                const cashRatio = (summary.totalCashValue / summary.totalValue * 100).toFixed(2);
                validation += `4. ç°é‡‘å æ¯”: ${cashRatio}%\n`;
            }
            
            validation += `\nğŸ’¡ ç»“è®º: ${hasCashValue && hasPositiveTotal ? 
                'å¤šå¸ç§ç°é‡‘å·²æˆåŠŸç»Ÿè®¡åˆ°æŠ•èµ„ç»„åˆä¸­ï¼' : 
                'éœ€è¦æ£€æŸ¥ç°é‡‘ç»Ÿè®¡é€»è¾‘'}`;
            
            validationDiv.innerHTML = validation;
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å¼€å§‹æµ‹è¯•
        window.onload = function() {
            setTimeout(() => {
                testLogin();
            }, 1000);
        };
    </script>
</body>
</html>